
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=ATnjAlnxbqj5mEG99nEBI3z7pBUoEyIuJfL8g6HfZdG7gsOD2-Su6hp9tFbxi4y3kDu9ODdLCUx28uRS&currency=USD"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBVTEC - Products</title>
   <style>
/* Base Styles */
html {
    margin: 0;
    padding: 0;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Arial', sans-serif;
    background: #FFFFFF;
    min-height: 100vh;
    color: white;
    padding-bottom: 80px;
    margin: 0;
    overflow-x: hidden;
}

/* Header Styles */
.header-lime-bar {
    background: #ffd700;
    height: 2px;
    width: 100%;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1002;
}

.header-top {
    background: #261A4C;
    padding: 0.5rem 1rem 0 1rem;
    margin: 0;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    position: relative;
    top: -1rem;
}

.header {
    background: rgba(0, 0, 0, 0.6);
    padding: 0.5rem;
    backdrop-filter: blur(10px);
    border-bottom: 2px solid #ffd700;
    position: relative;
    z-index: 1001;
    margin-top: 0;
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.logo {
    font-size: 2rem;
    font-weight: bold;
    color: black;
    text-shadow: 
        -1.5px -1.5px 0 #ffd700,
        1.5px -1.5px 0 #ffd700,
        -1.5px 1.5px 0 #ffd700,
        1.5px 1.5px 0 #ffd700,
        -1.5px 0 0 #ffd700,
        1.5px 0 0 #ffd700,
        0 -1.5px 0 #ffd700,
        0 1.5px 0 #ffd700;
    flex: 1;
    text-align: center;
}

.header-separator {
    width: 100vw;
    height: 2px;
    background: #ffd700;
    margin: 0;
    margin-left: calc(-50vw + 50%);
    position: relative;
}

/* Profile Section */
.profile-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.3s ease;
    min-width: 80px;
    margin-top: 0.3rem;
}

.profile-section:hover {
    background: rgba(255, 255, 255, 0.1);
}

.profile-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 18px;
    border: 2px solid #ffd700;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.profile-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.profile-btn {
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    white-space: nowrap;
    margin: 0;
}

/* Buttons */
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 25px;
    background: linear-gradient(45deg, #ffd700, #ffed4a);
    color: #333;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}

.btn-primary {
    background: linear-gradient(135deg, #007185, #005a6b);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0, 113, 133, 0.3);
}

.btn-edit, .btn-delete {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-edit {
    background: #007185;
    color: white;
}

.btn-edit:hover {
    background: #005a6b;
}

.btn-delete {
    background: #dc3545;
    color: white;
}

.btn-delete:hover {
    background: #c82333;
}

/* Search Section */
.search-container {
    width: 80%;
    max-width: 550px;
    position: relative;
    margin: 0 auto;
}

.search-bar {
    width: 100%;
    padding: 0.7rem 45px 0.7rem 1rem;
    border: none;
    border-radius: 25px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: white;
    font-size: 0.9rem;
    border: 2px solid rgba(255, 215, 0, 0.3);
}

.search-bar::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.search-bar:focus {
    outline: none;
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.2);
}

.search-btn {
    position: absolute;
    right: 3px;
    top: 50%;
    transform: translateY(-50%);
    width: 35px;
    height: 35px;
    background: linear-gradient(45deg, #ffd700, #ffed4a);
    color: #333;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.search-btn:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
}

/* Sell Button */
.sell-btn-clean {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
    background: none !important;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    flex-shrink: 0;
    min-width: 60px;
}

.sell-btn-clean:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    transform: translateY(-1px);
}

.sell-icon {
    color: #ffd700;
    margin-bottom: 0.1rem;
}

.sell-icon svg {
    width: 45px;
    height: 45px;
}

.sell-btn-clean span {
    font-size: 0.7rem;
    font-weight: bold;
    color: white;
    text-align: center;
}

/* Categories Section */
.categories-scroll::-webkit-scrollbar {
    display: none;
}

.category-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}

.category-btn.active {
    background: #333 !important;
    color: #ffd700 !important;
}

/* Floating Cart Widget */
.floating-cart-widget {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    width: 80px;
    height: 80px;
    background: linear-gradient(45deg, #ffd700, #ffed4a);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.floating-cart-widget:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

.cart-icon {
    font-size: 1.5rem;
    color: #333;
}

.cart-count-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border: 2px solid white;
    min-width: 22px;
}

/* Main Content */
.main-content {
    margin-left: 0;
    padding: 1rem 4px;
    max-width: 800px;
    margin: 0 auto;
    transition: margin-left 0.3s ease;
}

.products-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
    padding: 0 5px;
}

/* Product Cards */
.product-card {
    background: white;
    border-radius: 12px;
    padding: 8px;
    padding-bottom: 2px !important;
    border: 1px solid #e0e0e0;
    display: flex;
    gap: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
    cursor: pointer;
    min-height: 200px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.product-card:hover:not(:has(.add-to-cart:hover)) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.product-image {
    width: 200px;
    min-height: 250px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-left: 0;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.product-details {
    flex: 1;
    padding: 5px 15px 15px 0;
    display: flex;
    flex-direction: column;
}

.product-header {
    margin-bottom: 1rem;
}

.product-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.product-description {
    font-size: 1.2rem;
    color: #666;
    margin-bottom: 1rem;
    text-transform: uppercase;
    font-style: italic;
}

.rating-section {
    margin-bottom: 2rem;
}

.review-count {
    color: #333;
    font-size: 1.2rem;
    margin-left: 5px;
}

.stars {
    display: flex;
    gap: 3px;
    margin-bottom: 0.5rem;
    align-items: center;
}

.star {
    color: #ffa500;
    font-size: 1.5rem;
    line-height: 1;
}

.star.empty {
    color: #ddd;
}

.product-price {
    font-size: 2.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 2rem;
    text-transform: uppercase;
    font-style: italic;
}

.add-to-cart {
    background: #ffd814;
    color: #333;
    border: none;
    margin-bottom: 0 !important;
    padding: 0.3rem 2rem;
    border-radius: 50px;
    font-weight: bold;
    font-size: 1.1rem;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: auto;
    position: relative;
    z-index: 10;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    outline: none;
}

.add-to-cart:hover {
    background: #f7ca00;
    transform: scale(1.02);
}

.add-to-cart:active {
    transform: scale(0.98);
    background: #f7ca00;
}

.add-to-cart:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(255, 216, 20, 0.5);
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 10% auto;
    padding: 2rem;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    border: 2px solid #ffd700;
}

.close {
    color: #ffd700;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    z-index: 1;
    position: relative;
}

.close:hover,
.close:focus {
    color: #fff;
    text-decoration: none;
    cursor: pointer;
}

/* Forms */
.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #ffd700;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 0.7rem;
    border: none;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.form-group select option {
    background: #333;
    color: white;
    padding: 0.5rem;
}

.form-group textarea {
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
}

.form-group textarea::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

/* Dashboard Styles */
.dashboard-content {
    animation: fadeIn 0.3s ease-in-out;
}

.dashboard-content-wrapper {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.dashboard-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.dashboard-tab {
    flex: 1;
    padding: 1.2rem;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
    position: relative;
}

.dashboard-tab:hover {
    background: rgba(0, 113, 133, 0.05);
    color: #007185;
}

.dashboard-tab.active {
    color: #007185;
    background: white;
}

.dashboard-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: #007185;
}

.product-form {
    display: grid;
    gap: 1.5rem;
    padding: 2rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.form-field label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
}

.form-field input,
.form-field select,
.form-field textarea {
    width: 100%;
    max-width: 100%;
    padding: 0.9rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
    outline: none;
    border-color: #007185;
    box-shadow: 0 0 0 3px rgba(0, 113, 133, 0.1);
}

.product-grid {
    display: grid;
    gap: 1rem;
    padding: 2rem;
}

.dashboard-product-card {
    display: flex;
    gap: 1.5rem;
    padding: 1.5rem;
    background: white;
    border: 2px solid #f1f3f4;
    border-radius: 12px;
    transition: all 0.3s ease;
    position: relative;
}

.dashboard-product-card:hover {
    border-color: #007185;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.product-image-dash {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.product-info-dash {
    flex: 1;
    min-width: 0;
}

.product-title-dash {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
}

.product-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #666;
}

.product-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
    align-items: flex-start;
}

/* Product Detail View */
.product-detail-view {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: white;
    z-index: 1003;
    overflow-y: auto;
    padding: 0;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
}

.product-detail-view.active {
    display: block;
}

.product-gallery {
    text-align: center;
    margin-bottom: 2rem;
}

.product-gallery img {
    width: 100%;
    max-width: 400px;
    height: auto;
}

.detail-price {
    font-size: 2rem;
    font-weight: bold;
    color: #333;
    margin: 1rem 0;
}

.detail-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
}

.detail-add-to-cart {
    background: #ffd814;
    color: #333;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
}

/* Photo Gallery */
.photo-gallery {
    position: relative;
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    overflow: hidden;
    border-radius: 12px;
    touch-action: pan-y pinch-zoom;
    user-select: none;
    -webkit-user-select: none;
}

.photo-container {
    display: flex;
    transition: transform 0.3s ease;
    width: 500%;
    cursor: grab;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    touch-action: pan-y;
}

.photo-container:active {
    cursor: grabbing;
}

.photo-container.dragging {
    transition: none;
}

.photo-slide {
    width: 20%;
    flex-shrink: 0;
    position: relative;
}

.photo-slide img {
    width: 100%;
    height: 400px;
    object-fit: contain;
    background: white;
    pointer-events: none;
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
}

.photo-nav {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 15px;
}

.photo-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ddd;
    cursor: pointer;
    transition: background 0.3s ease;
}

.photo-dot.active {
    background: #007185;
}

/* Google Button */
.google-btn {
    transition: all 0.3s ease;
}

.google-btn:hover {
    background: #f8f9fa !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.google-btn:active {
    transform: scale(0.98);
}

/* Dynamic Form Container */
#dynamicFormContainer {
    animation: fadeIn 0.3s ease-in-out;
}

/* Menu Toggle */
.menu-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1001;
    background: rgba(255, 215, 0, 0.9);
    color: #333;
    border: none;
    padding: 0.5rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1.2rem;
}

/* Reviews */
.view-reviews {
    padding: 0.5rem 1rem;
    background: transparent;
    color: #0066c0;
    border: 1px solid #0066c0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
}

.view-reviews:hover {
    background: #0066c0;
    color: white;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    body {
        padding-bottom: 90px;
        overflow-x: hidden;
    }
    
    .header {
        padding: 0.4rem 0.25rem;
    }
    
    .header-content {
        gap: 0.25rem;
        margin-bottom: 0.25rem;
        padding: 0 0.5rem;
    }
    
    .search-container {
        width: 100% !important;
        max-width: calc(100vw - 200px) !important;
        margin: 0 auto;
    }
    
    .search-bar {
        padding: 0.6rem 35px 0.6rem 0.8rem;
        font-size: 0.8rem;
        width: 100%;
    }
    
    .search-btn {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
    }
    
    .profile-section {
        min-width: 50px;
        padding: 0.3rem;
        margin-top: 0.2rem;
        gap: 0.4rem;
        flex-shrink: 0;
    }
    
    .profile-avatar {
        width: 40px;
        height: 40px;
        font-size: 17px;
    }

    .profile-btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.3rem;
    }

    .sell-btn-clean {
        min-width: 50px;
        padding: 0.3rem;
        flex-shrink: 0;
    }
    
    .sell-btn-clean span {
        font-size: 0.6rem;
    }
    
    .sell-icon svg {
        width: 35px;
        height: 35px;
    }
    
    .floating-cart-widget {
        width: 55px;
        height: 55px;
        bottom: 15px;
        right: 15px;
    }

    .cart-icon {
        font-size: 1.3rem;
    }
    
    .cart-count-badge {
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        min-width: 20px;
    }

    /* Categories */
    .categories-section {
        padding: 0.2rem 0.5rem;
        margin-bottom: 0.25rem;
    }
    
    .categories-scroll {
        gap: 0.5rem;
        padding: 0.3rem 0;
    }
    
    .category-btn {
        padding: 0.5rem 1rem !important;
        font-size: 0.8rem !important;
        min-width: auto !important;
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Product Cards */
    .product-card {
        flex-direction: row;
        padding: 0.75rem;
        gap: 0.75rem;
        min-height: 280px;
        overflow: visible;
        margin-bottom: 1rem;
    }
    
    .product-image {
        width: 120px;
        min-height: 160px;
        max-height: 160px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        max-width: 120px;
        max-height: 160px;
    }
    
    .product-details {
        padding: 8px 12px 12px 0;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        min-height: 160px;
        gap: 0.5rem;
        position: relative;
        min-width: 0;
    }

    .product-header {
        margin-bottom: 0.5rem;
        flex-shrink: 0;
    }

    .product-title {
        font-size: 1rem;
        margin-bottom: 0.3rem;
        line-height: 1.2;
        word-wrap: break-word;
    }

    .product-description {
        font-size: 0.8rem;
        margin-bottom: 0.2rem !important;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .rating-section {
        margin-bottom: 0.5rem;
        flex-shrink: 0;
    }

    .rating-section h4 {
        display: none;
    }

    .stars {
        gap: 2px;
        margin-bottom: 0.3rem;
    }

    .star {
        font-size: 1rem;
    }

    .review-count {
        font-size: 0.9rem;
    }

    .delivery-info {
        margin: 0.3rem 0;
        flex-shrink: 0;
    }

    .delivery-line {
        color: #007185 !important;
        font-size: 0.75rem !important;
        margin: 0.1rem 0 !important;
        font-weight: 500 !important;
        line-height: 1.2 !important;
    }

   .seller-info {
        color: #666 !important;
        font-size: 0.75rem !important;
        font-weight: bold !important;
        margin: 0.2rem 0 !important;
        line-height: 1.2 !important;
        word-wrap: break-word !important;
        flex-shrink: 0;
    }

    .product-price {
        font-size: 1.6rem;
        margin-bottom: 0.8rem;
        margin-top: auto;
        flex-shrink: 0;
        line-height: 1;
    }

    .add-to-cart {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        margin-bottom: 0 !important;
        flex-shrink: 0;
        user-select: none !important;
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        outline: none !important;
        -webkit-tap-highlight-color: transparent !important;
        white-space: nowrap;
        align-self: flex-end;
        width: fit-content;
        margin-left: auto;
    }

    /* Modal Fixes */
    .modal-content {
        margin: 5% auto !important;
        width: 95% !important;
        max-width: 95% !important;
        max-height: 90vh;
        overflow-y: auto;
        padding: 1rem;
    }

    #editProductModal .modal-content {
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
    
    #sellerModal .modal-content {
        padding: 1rem !important;
    }

    /* Form Fields Mobile */
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-field input,
    .form-field select,
    .form-field textarea {
        font-size: 0.9rem;
        padding: 0.75rem;
    }

    .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    /* Photo Gallery Mobile */
    .photo-slide img {
        height: 300px;
    }
    
    .photo-gallery {
        touch-action: manipulation;
    }

    /* Dashboard Mobile */
    .dashboard-content-wrapper {
        margin: 0.5rem;
        border-radius: 12px;
    }
    
    .dashboard-tabs {
        flex-wrap: wrap;
    }
    
    .dashboard-tab {
        flex: 1;
        min-width: 120px;
        padding: 0.8rem 0.5rem;
        font-size: 0.85rem;
    }
    
    .dashboard-product-card {
        flex-direction: column;
        padding: 1rem;
    }
    
    .product-image-dash {
        width: 100%;
        height: 150px;
        margin-bottom: 1rem;
    }
    
    .product-actions {
        justify-content: space-between;
        gap: 0.5rem;
    }
    
    .btn-edit, .btn-delete {
        flex: 1;
        padding: 0.6rem;
    }

    /* Prevent tap highlighting */
    *, *::before, *::after {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
    }

    .main-content {
        padding: 0.5rem 4px;
    }
    
    .products-grid {
        gap: 1rem;
        padding: 0 5px;
    }

    /* PayPal button container */
    #paypal-button-container {
        margin: 1rem 0;
        max-width: 100%;
    }
}

/* Extra small screens */
@media (max-width: 480px) {
    .header-content {
        gap: 0.3rem;
    }
    
    .search-container {
        width: calc(100vw - 160px) !important;
        max-width: calc(100vw - 160px) !important;
    }
    
    .profile-section {
        min-width: 50px;
    }
    
    .sell-btn-clean {
        min-width: 45px;
    }
    
    #sellerBtnText {
        display: none;
    }
    
    .sell-btn-clean::after {
        content: "SELL";
        font-size: 0.6rem;
        font-weight: bold;
        color: white;
    }

    .add-to-cart {
        align-self: flex-end;
        margin-left: auto;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }

    .product-card {
        min-height: 260px;
        padding: 0.5rem;
        gap: 0.5rem;
    }
    
    .product-image {
        width: 100px;
        min-height: 140px;
        max-height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .product-image img {
        max-width: 100px;
        max-height: 140px;
    }

    .product-title {
        font-size: 0.85rem;
    }
    
    .product-description {
        font-size: 0.75rem;
        -webkit-line-clamp: 2;
    }
    
    .product-price {
        font-size: 1.2rem;
    }
}

/* Larger screens optimization */
@media (min-width: 1200px) {
    .main-content {
        max-width: 1000px;
    }
    
    .search-container {
        max-width: 600px;
    }
    
    .product-card {
        min-height: 220px;
    }
}

/* High DPI displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .product-image img {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
}

/* Print styles */
@media print {
    .header, .floating-cart-widget, .modal {
        display: none !important;
    }
    
    .product-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
</style>
</head>
<body>
    
<!-- Header -->
<header class="header">
    <div class="header-lime-bar"></div>
    <div class="header-top">
        <div class="header-content">
            <!-- Profile Section - Left -->
            <div class="profile-section" onclick="showLogin()">
                <div class="profile-avatar" id="profileAvatar">W</div>
                <button class="btn profile-btn" id="signInBtn">PROFILE</button>
            </div>

                <div class="logo">WEB VTEC</div>
            
            <!-- Sell Button - Right (no background) -->
            <button class="sell-btn-clean" id="dynamicSellerBtn" onclick="handleSellerButton()">
                <div class="sell-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 2.8l6 6V20h-2v-6H8v6H6v-8.2l6-6z"/>
                    </svg>
                </div>
                <span id="sellerBtnText">SELL</span>
            </button>
        </div>

        <div class="header-separator"></div>
    </div>

    <!-- Categories Section -->
    <div class="categories-section" style="padding: 0.2rem 5px; margin-bottom: 0.25rem;">
        <div class="categories-scroll" style="display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.3rem 0; scrollbar-width: none; -ms-overflow-style: none;">
            <button class="category-btn active" onclick="filterByCategory('all')" style="background: #333; color: #ffd700; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">All</button>
            <button class="category-btn" onclick="filterByCategory('electronics')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 90px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Electronics</button>
            <button class="category-btn" onclick="filterByCategory('clothing')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 80px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Clothing</button>
            <button class="category-btn" onclick="filterByCategory('home')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Home</button>
            <button class="category-btn" onclick="filterByCategory('beauty')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Beauty</button>
            <button class="category-btn" onclick="filterByCategory('sports')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Sports</button>
            <button class="category-btn" onclick="filterByCategory('books')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Books</button>
            <button class="category-btn" onclick="filterByCategory('toys')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Toys</button>
            <button class="category-btn" onclick="filterByCategory('automotive')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 95px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Automotive</button>
            <button class="category-btn" onclick="filterByCategory('jewelry')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 80px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Jewelry</button>
            <button class="category-btn" onclick="filterByCategory('health')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Health</button>
            <button class="category-btn" onclick="filterByCategory('music')" style="background: #ffd700; color: #333; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Music</button>
        </div>
    </div>


    <!-- Search Container - Center -->
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search products..." onkeyup="searchProducts()">
                <button class="search-btn" onclick="searchProducts()">🔍</button>
            </div>
</header>

<!-- Floating Cart Widget -->
<div class="floating-cart-widget" onclick="showCart()">
    <div class="cart-icon">🛒</div>
    <span class="cart-count-badge" id="cartCountFloat">0</span>
</div>

    
<main class="main-content">
    <div class="products-grid" id="productsGrid">
        <!-- Products will be loaded here -->
    </div>
</main>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeLogin()">&times;</span>
        <h2 style="color: #ffd700; margin-bottom: 1rem;" id="modalTitle">Sign In</h2>
        
        <!-- Email/Password Form -->
        <div id="authFormSection">
            <form id="authForm" onsubmit="handleEmailAuth(event)">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" required minlength="6">
                    <a href="#" onclick="showForgotPassword()" style="color: #ffd700; font-size: 0.8rem; text-decoration: none; margin-top: 0.3rem; display: block;">Forgot Password?</a>
                </div>

                <!-- Google Sign In Button (only show when not signed in) -->
                <div id="googleSignInSection">
                    <button type="button" onclick="signInWithGoogle()" class="google-btn" style="width: 100%; margin-bottom: 1rem; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; background: white; color: #333; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" style="width: 18px; height: 18px;">
                        Continue with Google
                    </button>
                    <div style="text-align: center; margin: 1rem 0; color: #ccc;">OR</div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;" id="authSubmitBtn">Sign In</button>
            </form>
            <p style="text-align: center; margin-top: 1rem;" id="switchSection">
                <span id="switchText">Don't have an account?</span> 
                <a href="#" style="color: #ffd700;" onclick="toggleAuthMode()" id="switchLink">Sign Up</a>
            </p>
        </div>
        
        <!-- User Profile Display (centered, hidden by default) -->
        <div id="userInfo" style="display: none; text-align: center; margin-top: 1rem;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                <img id="userPhoto" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #ffd700; display: none;">
                <div>
                    <p id="userName" style="color: #ffd700; font-size: 1.2rem; margin: 0;"></p>
                    <p id="userEmail" style="color: #ccc; font-size: 0.9rem; margin: 0.5rem 0;"></p>
                </div>
                <button onclick="signOut()" class="btn" style="margin-top: 1rem;">Sign Out</button>
            </div>
        </div>
    </div>
</div>

<!-- Seller Signup Modal -->
<div id="sellerModal" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 1.5rem;">
        <span class="close" onclick="closeSellerSignup()">&times;</span>
        <h2 style="color: #ffd700; margin-bottom: 1rem; text-align: center; font-size: 1.3rem;">BECOME A WEB VTEC Seller</h2>
        
        <!-- Premium Benefits Section - Show First -->
        <div style="background: rgba(255, 215, 0, 0.05); padding: 1.5rem; border-radius: 8px; margin: 1rem 0; border: 1px solid rgba(255, 215, 0, 0.2);">
            <h3 style="color: #ffd700; margin: 0 0 1rem 0; text-align: center;">Premium Seller Benefits</h3>
            <ul style="color: #ccc; margin: 0; padding-left: 1.5rem; font-size: 0.9rem; line-height: 1.6;">
                <li>Up to 50 product listings</li>
                <li>Advanced order management dashboard</li>
                <li>Customer communication tools</li>
                <li>Detailed sales analytics & reporting</li>
                <li>Priority customer support</li>
                <li>Marketing tools and promotions</li>
                <li>Bulk inventory management</li>
                <li>Custom store branding</li>
            </ul>
        </div>
        
        
        <form id="sellerSignupForm" onsubmit="handleSellerSignup(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group" style="margin-bottom: 0.8rem;">
                    <label style="font-size: 0.9rem;">First Name:</label>
                    <input type="text" id="sellerFirstName" required style="padding: 0.5rem; font-size: 0.9rem;">
                </div>
                <div class="form-group" style="margin-bottom: 0.8rem;">
                    <label style="font-size: 0.9rem;">Last Name:</label>
                    <input type="text" id="sellerLastName" required style="padding: 0.5rem; font-size: 0.9rem;">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 0.8rem;">
                <label style="font-size: 0.9rem;">Date of Birth:</label>
                <div style="display: flex; gap: 0.5rem;">
                    <select id="sellerMonth" required style="flex: 1; padding: 0.5rem; border: none; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 215, 0, 0.3); font-size: 0.9rem;">
                        <option value="">Month</option>
                        <option value="01">Jan</option>
                        <option value="02">Feb</option>
                        <option value="03">Mar</option>
                        <option value="04">Apr</option>
                        <option value="05">May</option>
                        <option value="06">Jun</option>
                        <option value="07">Jul</option>
                        <option value="08">Aug</option>
                        <option value="09">Sep</option>
                        <option value="10">Oct</option>
                        <option value="11">Nov</option>
                        <option value="12">Dec</option>
                    </select>
                    <select id="sellerDay" required style="flex: 1; padding: 0.5rem; border: none; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 215, 0, 0.3); font-size: 0.9rem;">
                        <option value="">Day</option>
                    </select>
                    <select id="sellerYear" required style="flex: 1; padding: 0.5rem; border: none; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 215, 0, 0.3); font-size: 0.9rem;">
                        <option value="">Year</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 0.8rem;">
                <label style="font-size: 0.9rem;">Email:</label>
                <input type="email" id="sellerEmail" required style="padding: 0.5rem; font-size: 0.9rem;">
            </div>
            
            <div class="form-group" style="margin-bottom: 0.8rem;">
                <label style="font-size: 0.9rem;">Password:</label>
                <input type="password" id="sellerPassword" required minlength="6" style="padding: 0.5rem; font-size: 0.9rem;">
            </div>
            
            <div class="form-group" style="margin-bottom: 0.8rem;">
                <label style="font-size: 0.9rem;">Phone Number:</label>
                <input type="tel" id="sellerPhone" required style="padding: 0.5rem; font-size: 0.9rem;">
            </div>
            
            <div class="form-group" style="margin-bottom: 0.8rem;">
                <label style="font-size: 0.9rem;">Business Name:</label>
                <input type="text" id="sellerBusiness" required style="padding: 0.5rem; font-size: 0.9rem;">
            </div>

            <!-- Add Google Sign-In for Sellers -->
            <button type="button" onclick="signUpSellerWithGoogle()" class="google-btn" style="width: 100%; margin-bottom: 1rem; padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px; background: white; color: #333; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" style="width: 16px; height: 16px;">
                Continue with Google
            </button>
            <div style="text-align: center; margin: 1rem 0; color: #ccc; font-size: 0.85rem;">OR</div>
            
            <button type="submit" class="btn" style="width: 100%; font-size: 1rem; padding: 0.8rem;">START SUBSCRIPTION ($2,300/MONTH)</button>
        </form>
    </div>
</div>

<!-- Seller Dashboard Page -->
<div id="sellerDashboardPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #f8f9fa; z-index: 2000; overflow-y: auto;">
    <!-- Header -->
    <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem 0; position: sticky; top: 0; z-index: 100;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="closeSellerDashboardPage()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.6rem 1.2rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s ease; backdrop-filter: blur(10px);">← Back to Store</button>
                <div style="text-align: center;">
                    <h1 style="color: white; margin: 0; font-size: 1.8rem; font-weight: 500;">Seller Dashboard</h1>
                    <p style="color: rgba(255,255,255,0.9); margin: 0.3rem 0 0 0; font-size: 0.9rem;" id="sellerWelcome">Welcome back!</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        <!-- Navigation Tabs -->
        <div class="dashboard-content-wrapper" style="margin-bottom: 2rem;">
            <!-- Replace the existing dashboard-tabs div with this: -->
<div class="dashboard-tabs">
    <button class="dashboard-tab active" onclick="showDashboardTab('overview', event)">📊 Overview</button>
    <button class="dashboard-tab" onclick="showDashboardTab('orders', event)">📋 Orders</button>
    <button class="dashboard-tab" onclick="showDashboardTab('my-products', event)">📦 My Products</button>
    <button class="dashboard-tab" onclick="showDashboardTab('add-product', event)">➕ Add Product</button>
</div>
        </div>


        <!-- Orders Tab -->
<div id="orders-tab" class="dashboard-content" style="display: none;">
    <div class="dashboard-content-wrapper">
        <div style="padding: 2rem; border-bottom: 1px solid #e9ecef;">
            <h3 style="color: #333; margin: 0; font-size: 1.4rem; font-weight: 600;">Order Management</h3>
            <p style="color: #666; margin: 0.5rem 0 0 0;">Manage customer orders and update their status.</p>
        </div>
        
        <div id="sellerOrdersList" style="padding: 2rem;">
            <!-- Orders will be loaded here -->
        </div>
    </div>
</div>

        <!-- Overview Tab -->
<div id="overview-tab" class="dashboard-content">
    <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;">
        <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; min-width: 120px; max-width: 150px;">
            <div style="width: 30px; height: 30px; background: rgba(0, 113, 133, 0.1); color: #007185; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem auto; font-size: 1rem;">📦</div>
            <h3 style="color: #666; margin: 0 0 0.3rem 0; font-size: 0.7rem; font-weight: 500; text-transform: uppercase;">Total Products</h3>
            <div style="font-size: 1.4rem; font-weight: 700; color: #007185;" id="totalProducts">0</div>
        </div>
        <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; min-width: 120px; max-width: 150px;">
            <div style="width: 30px; height: 30px; background: rgba(40, 167, 69, 0.1); color: #28a745; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem auto; font-size: 1rem;">💰</div>
            <h3 style="color: #666; margin: 0 0 0.3rem 0; font-size: 0.7rem; font-weight: 500; text-transform: uppercase;">Monthly Revenue</h3>
            <div style="font-size: 1.4rem; font-weight: 700; color: #28a745;">$0</div>
        </div>
    </div>
</div>
        
        <!-- Add Product Tab -->
        <div id="add-product-tab" class="dashboard-content" style="display: none;">
            <div class="dashboard-content-wrapper">
                <div style="padding: 2rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="color: #333; margin: 0; font-size: 1.4rem; font-weight: 600;">Add New Product</h3>
                    <p style="color: #666; margin: 0.5rem 0 0 0;">Fill in the details below to add a new product to your store.</p>
                </div>
                
                <form id="dashboardAddProductForm" onsubmit="handleDashboardAddProduct(event)" class="product-form">
                    <div class="form-row">
                        <div class="form-field">
                            <label>Product Name</label>
                            <input type="text" id="dashboardProductName" required placeholder="Enter product name" maxlength="30">
                        </div>
                        <div class="form-field">
                            <label>Price ($)</label>
                            <input type="number" id="dashboardProductPrice" step="0.01" min="0" required placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-field">
                        <label>Description</label>
                        <textarea id="dashboardProductDescription" rows="4" required placeholder="Describe your product..."></textarea>
                    </div>
                    
                    <div class="form-row">
    <div class="form-field">
        <label>Category</label>
        <select id="dashboardProductCategory" required>
            <option value="">Select Category</option>
            <option value="electronics">Electronics</option>
            <option value="clothing">Clothing</option>
            <option value="home">Home</option>
            <option value="beauty">Beauty</option>
            <option value="sports">Sports</option>
            <option value="books">Books</option>
            <option value="toys">Toys</option>
            <option value="automotive">Automotive</option>
            <option value="jewelry">Jewelry</option>
            <option value="health">Health</option>
            <option value="music">Music</option>
        </select>
    </div>
    <div class="form-field">
        <label>Product Images (up to 5 URLs)</label>
        <input type="url" id="dashboardProductImage1" required placeholder="Main image URL" style="margin-bottom: 0.5rem;">
        <input type="url" id="dashboardProductImage2" placeholder="Additional image URL (optional)" style="margin-bottom: 0.5rem;">
        <input type="url" id="dashboardProductImage3" placeholder="Additional image URL (optional)" style="margin-bottom: 0.5rem;">
        <input type="url" id="dashboardProductImage4" placeholder="Additional image URL (optional)" style="margin-bottom: 0.5rem;">
        <input type="url" id="dashboardProductImage5" placeholder="Additional image URL (optional)">
    </div>
</div>

<div class="form-row">
    <div class="form-field">
        <label>Stock Quantity</label>
        <input type="number" id="dashboardProductStock" min="0" value="10" required>
        <small style="color: #666; display: block; margin-top: 0.3rem;">Available quantity for sale</small>
    </div>
    <div class="form-field">
        <label>Low Stock Alert</label>
        <input type="number" id="dashboardLowStockAlert" min="0" value="5" required>
        <small style="color: #666; display: block; margin-top: 0.3rem;">Get notified when stock reaches this level</small>
    </div>
</div>

<div class="form-row" id="clothingSizeRow" style="display: none;">
    <div class="form-field">
        <label>Available Sizes</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" value="XS"> XS
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" value="S"> S
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" value="M"> M
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" value="L"> L
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" value="XL"> XL
            </label>
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" value="XXL"> XXL
            </label>
        </div>
    </div>
</div>


                    
                    <div class="form-row">
                        <div class="form-field">
                            <label>Knutsford Delivery Time</label>
                            <select id="dashboardKnutsfordDelivery" required>
                                <option value="">Select Delivery Time</option>
                                <option value="1-2">1-2 days</option>
                                <option value="3-5">3-5 days</option>
                                <option value="5-7">5-7 days</option>
                                <option value="7-10">7-10 days</option>
                                <option value="10-14">10-14 days</option>
                                <option value="14-21">14-21 days</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Tara Delivery Time</label>
                            <select id="dashboardTaraDelivery" required>
                                <option value="">Select Delivery Time</option>
                                <option value="2-7">2-7 days</option>
                                <option value="7-10">7-10 days</option>
                                <option value="10-14">10-14 days</option>
                                <option value="14-21">14-21 days</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary">Add Product</button>
                </form>
            </div>
        </div>

        <!-- My Products Tab -->
        <div id="my-products-tab" class="dashboard-content" style="display: none;">
            <div class="dashboard-content-wrapper">
                <div style="padding: 2rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="color: #333; margin: 0; font-size: 1.4rem; font-weight: 600;">My Products</h3>
                    <p style="color: #666; margin: 0.5rem 0 0 0;">Manage your product listings below.</p>
                </div>
                <div id="dashboardProductsList" class="product-grid">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- Customer Orders Page -->
<div id="customerOrdersPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #f8f9fa; z-index: 2000; overflow-y: auto;">
    <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem 0; position: sticky; top: 0; z-index: 100;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="closeCustomerOrders()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.6rem 1.2rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s ease; backdrop-filter: blur(10px);">← Back to Store</button>
                <div style="text-align: center;">
                    <h1 style="color: white; margin: 0; font-size: 1.8rem; font-weight: 500;">My Orders</h1>
                    <p style="color: rgba(255,255,255,0.9); margin: 0.3rem 0 0 0; font-size: 0.9rem;">Track your purchases</p>
                </div>
                <div style="width: 140px;"></div>
            </div>
        </div>
    </header>

    <div id="customerOrdersList" style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
        <!-- Customer orders will be loaded here -->
    </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgotPasswordModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <span class="close" onclick="closeForgotPassword()">&times;</span>
        <h2 style="color: #ffd700; margin-bottom: 1rem; text-align: center;">Reset Password</h2>
        <p style="color: #ccc; text-align: center; margin-bottom: 1.5rem; font-size: 0.9rem;">Enter your email address and we'll send you a link to reset your password.</p>
        
        <form id="forgotPasswordForm" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="forgotEmail" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">Send Reset Link</button>
        </form>
        
        <p style="text-align: center; margin-top: 1rem;">
            <a href="#" style="color: #ffd700;" onclick="closeForgotPassword(); showLogin();">Back to Sign In</a>
        </p>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="editProductModal" class="modal">
    <div class="modal-content" style="max-width: 700px; padding: 0; border-radius: 16px; overflow: hidden; max-height: 90vh; overflow-y: auto;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; text-align: center; position: relative;">
            <span class="close" onclick="closeEditProduct()" style="position: absolute; top: 1rem; right: 1.5rem; color: white; font-size: 2rem;">&times;</span>
            <h2 style="color: white; margin: 0; font-size: 1.8rem; font-weight: 300;">Edit Product</h2>
            <p style="color: rgba(255,255,255,0.9); margin: 0.5rem 0 0 0;">Update your product details below</p>
        </div>
        
        <div style="padding: 2rem;">
             <form id="editProductForm" onsubmit="handleEditProduct(event)" class="product-form">
                <input type="hidden" id="editProductId">
                
                <div class="form-row">
                    <div class="form-field">
                        <label>Product Name</label>
                        <input type="text" id="editProductName" required maxlength="30">
                    </div>
                    <div class="form-field">
                        <label>Price ($)</label>
                        <input type="number" id="editProductPrice" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-field">
                    <label>Description</label>
                    <textarea id="editProductDescription" rows="3" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-field">
                        <label>Category</label>
                        <select id="editProductCategory" required>
                            <option value="">Select Category</option>
                            <option value="electronics">Electronics</option>
                            <option value="clothing">Clothing</option>
                            <option value="home">Home</option>
                            <option value="beauty">Beauty</option>
                            <option value="sports">Sports</option>
                            <option value="books">Books</option>
                            <option value="toys">Toys</option>
                            <option value="automotive">Automotive</option>
                            <option value="jewelry">Jewelry</option>
                            <option value="health">Health</option>
                            <option value="music">Music</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Product Images (up to 5 URLs)</label>
                        <input type="url" id="editProductImage1" required placeholder="Main image URL" style="margin-bottom: 0.5rem;">
                        <input type="url" id="editProductImage2" placeholder="Additional image URL (optional)" style="margin-bottom: 0.5rem;">
                        <input type="url" id="editProductImage3" placeholder="Additional image URL (optional)" style="margin-bottom: 0.5rem;">
                        <input type="url" id="editProductImage4" placeholder="Additional image URL (optional)" style="margin-bottom: 0.5rem;">
                        <input type="url" id="editProductImage5" placeholder="Additional image URL (optional)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-field">
                        <label>Knutsford Delivery Time</label>
                        <select id="editKnutsfordDelivery" required>
                            <option value="">Select Delivery Time</option>
                            <option value="1-2">1-2 days</option>
                            <option value="3-5">3-5 days</option>
                            <option value="5-7">5-7 days</option>
                            <option value="7-10">7-10 days</option>
                            <option value="10-14">10-14 days</option>
                            <option value="14-21">14-21 days</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Tara Delivery Time</label>
                        <select id="editTaraDelivery" required>
                            <option value="">Select Delivery Time</option>
                            <option value="2-7">2-7 days</option>
                            <option value="7-10">7-10 days</option>
                            <option value="10-14">10-14 days</option>
                            <option value="14-21">14-21 days</option>
                        </select>
                    </div>
                </div>

                 <div class="form-row">
    <div class="form-field">
        <label>Stock Quantity</label>
        <input type="number" id="editProductStock" min="0" required>
        <small style="color: #666; display: block; margin-top: 0.3rem;">Available quantity for sale</small>
    </div>
    <div class="form-field">
        <label>Low Stock Alert</label>
        <input type="number" id="editLowStockAlert" min="0" required>
        <small style="color: #666; display: block; margin-top: 0.3rem;">Get notified when stock reaches this level</small>
    </div>
                 </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
                    <button type="submit" class="btn-primary">Update Product</button>
                    <button type="button" onclick="closeEditProduct()" style="background: #6c757d; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
// ================================
// FIREBASE CONFIGURATION & INITIALIZATION
// ================================
const firebaseConfig = {
    apiKey: "AIzaSyD01uGyvyD9vyXa6SFAqxqEdEFuedc-b5M",
    authDomain: "e-commerce-f2233.firebaseapp.com",
    projectId: "e-commerce-f2233",
    storageBucket: "e-commerce-f2233.firebasestorage.app",
    messagingSenderId: "363586978941",
    appId: "1:363586978941:web:35b3b34237bca75b405d14"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Initialize Google provider
const googleProvider = new firebase.auth.GoogleAuthProvider();
googleProvider.addScope('email');
googleProvider.addScope('profile');

// ================================
// INITIALIZATION & EVENT LISTENERS
// ================================


    let currentUser = null;
let isSignUpMode = false;
let cart = [];
let products = [];
let currentCategory = 'all';
let currentPhotoIndex = 0;
let currentProductId = null;



    
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    console.log('Firebase available:', typeof firebase !== 'undefined');
    console.log('Firebase Auth available:', typeof firebase !== 'undefined' && !!firebase.auth);
    console.log('Auth instance:', auth);
    
    loadProductsFromFirebase();
    updateCartCount();
    
    // Add category change listener
    setTimeout(() => {
        const categorySelect = document.getElementById('dashboardProductCategory');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                const sizeRow = document.getElementById('clothingSizeRow');
                if (sizeRow) {
                    if (this.value === 'clothing') {
                        sizeRow.style.display = 'block';
                    } else {
                        sizeRow.style.display = 'none';
                    }
                }
            });
        }
    }, 1000);
});


// Window click event handler for modals
window.onclick = function(event) {
    const modal = document.getElementById('loginModal');
    const sellerModal = document.getElementById('sellerModal');
    const sellerDashboard = document.getElementById('sellerDashboard');
    const forgotModal = document.getElementById('forgotPasswordModal');
    const editModal = document.getElementById('editProductModal');
    
    if (event.target === modal) {
        closeLogin();
    }
    
    if (event.target === sellerModal) {
        closeSellerSignup();
    }
    
    if (event.target === sellerDashboard) {
        closeSellerDashboard();
    }
    
    if (event.target === forgotModal) {
        closeForgotPassword();
    }
    
    if (event.target === editModal) {
        closeEditProduct();
    }
    
    // Handle other modals
    if (event.target.classList.contains('modal') && 
        event.target !== modal && 
        event.target !== sellerModal && 
        event.target !== sellerDashboard && 
        event.target !== forgotModal &&
        event.target !== editModal) {
        event.target.style.display = 'none';
    }
};

// Document click event handler for sidebar
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.querySelector('.menu-toggle');
    
    if (sidebar && menuToggle && !sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
        sidebar.classList.remove('open');
    }
});

auth.onAuthStateChanged((user) => {
    currentUser = user;
    updateAuthUI();
});

// ================================
// AUTHENTICATION FUNCTIONS
// ================================
function signInWithGoogle() {
    console.log('Google sign-in button clicked');
    
    // Check if Firebase Auth is loaded
    if (typeof firebase === 'undefined' || !firebase.auth) {
        console.error('Firebase Auth not loaded');
        alert('Authentication system not ready. Please refresh the page.');
        return;
    }
    
    console.log('Attempting Google sign-in...');
    
    auth.signInWithPopup(googleProvider)
        .then((result) => {
            currentUser = result.user;
            console.log('Google sign-in successful:', currentUser);
            updateAuthUI();
            closeLogin();
            alert(`Welcome ${currentUser.displayName || currentUser.email}!`);
        })
        .catch((error) => {
            console.error('Google sign-in error:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            
            let errorMessage = 'Error signing in with Google: ';
            switch(error.code) {
                case 'auth/popup-closed-by-user':
                    errorMessage += 'Sign-in cancelled.';
                    break;
                case 'auth/popup-blocked':
                    errorMessage += 'Pop-up blocked. Please allow pop-ups.';
                    break;
                case 'auth/unauthorized-domain':
                    errorMessage += 'Domain not authorized. Contact support.';
                    break;
                default:
                    errorMessage += error.message;
            }
            alert(errorMessage);
        });
}

function handleEmailAuth(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (isSignUpMode) {
        // Sign Up
        auth.createUserWithEmailAndPassword(email, password)
            .then((result) => {
                currentUser = result.user;
                console.log('Sign up successful:', currentUser);
                updateAuthUI();
                closeLogin();
                alert('Account created successfully!');
            })
            .catch((error) => {
                console.error('Sign up error:', error);
                alert('Error creating account: ' + error.message);
            });
    } else {
        // Sign In
        auth.signInWithEmailAndPassword(email, password)
            .then((result) => {
                currentUser = result.user;
                console.log('Sign in successful:', currentUser);
                updateAuthUI();
                closeLogin();
            })
            .catch((error) => {
                console.error('Sign in error:', error);
                alert('Error signing in: ' + error.message);
            });
    }
}

function signOut() {
    auth.signOut().then(() => {
        currentUser = null;
        updateAuthUI();
        closeLogin();
        alert('You have been signed out successfully.');
        console.log('User signed out');
    }).catch((error) => {
        console.error('Sign out error:', error);
        alert('Error signing out. Please try again.');
    });
}

function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    updateAuthModalUI();
}

function updateAuthModalUI() {
    const modalTitle = document.getElementById('modalTitle');
    const submitBtn = document.getElementById('authSubmitBtn');
    const switchText = document.getElementById('switchText');
    const switchLink = document.getElementById('switchLink');
    
    if (isSignUpMode) {
        modalTitle.textContent = 'Sign Up';
        submitBtn.textContent = 'Sign Up';
        switchText.textContent = 'Already have an account?';
        switchLink.textContent = 'Sign In';
    } else {
        modalTitle.textContent = 'Sign In';
        submitBtn.textContent = 'Sign In';
        switchText.textContent = "Don't have an account?";
        switchLink.textContent = 'Sign Up';
    }
}

function updateAuthUI() {
    const signInBtn = document.getElementById('signInBtn');
    const profileAvatar = document.getElementById('profileAvatar');
    
    if (currentUser) {
        const displayName = currentUser.displayName || 'User';
        const firstName = displayName.split(' ')[0];
        signInBtn.innerHTML = `${firstName}`;
        
        // Update avatar
        if (currentUser.photoURL) {
            profileAvatar.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
        } else {
            // Use first letter of name or email
            const initial = displayName.charAt(0).toUpperCase() || currentUser.email.charAt(0).toUpperCase();
            profileAvatar.innerHTML = initial;
        }
    } else {
        signInBtn.innerHTML = 'Sign In';
        profileAvatar.innerHTML = 'W';
    }
    
    updateSellerButton();
    updateDetailPageAuth();
}

// ================================
// LOGIN/PROFILE MODAL FUNCTIONS
// ================================
function showLogin() {
    const modal = document.getElementById('loginModal');
    
    if (currentUser) {
        // User is signed in - show profile
        showUserProfile();
    } else {
        // User not signed in - show login form
        showLoginForm();
    }
}

function showLoginForm() {
    // Reset to sign-in mode
    isSignUpMode = false;
    updateAuthModalUI();
    
    // Show login elements, hide profile
    document.getElementById('googleSignInSection').style.display = 'block';
    document.getElementById('authFormSection').style.display = 'block';
    document.getElementById('userInfo').style.display = 'none';
    
    // Clear form
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    
    // Show modal
    document.getElementById('loginModal').style.display = 'block';
}

function showUserProfile() {
    if (currentUser) {
        // Check if user is a seller first
        db.collection('sellers').doc(currentUser.uid).get()
            .then((doc) => {
                // Hide login elements, show profile
                document.getElementById('googleSignInSection').style.display = 'none';
                document.getElementById('authFormSection').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('modalTitle').textContent = 'Profile';
                
                // Update user info
                document.getElementById('userName').textContent = currentUser.displayName || 'User';
                document.getElementById('userEmail').textContent = currentUser.email;
                
                if (currentUser.photoURL) {
                    document.getElementById('userPhoto').src = currentUser.photoURL;
                    document.getElementById('userPhoto').style.display = 'block';
                } else {
                    document.getElementById('userPhoto').style.display = 'none';
                }
                
                // Update userInfo section
                const userInfoDiv = document.getElementById('userInfo');
                const existingButtons = userInfoDiv.querySelector('.profile-buttons');
                if (existingButtons) existingButtons.remove();
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'profile-buttons';
                buttonsDiv.style.cssText = 'display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem;';
                
                if (doc.exists) {
                    // User is a seller - only show seller dashboard
                    buttonsDiv.innerHTML = `
                        <button onclick="closeLogin(); showSellerDashboard();" class="btn" style="width: 100%;">Seller Dashboard</button>
                        <button onclick="signOut()" class="btn" style="width: 100%;">Sign Out</button>
                    `;
                } else {
                    // User is not a seller
                    buttonsDiv.innerHTML = `
                        <button onclick="closeLogin(); showSellerSignup();" class="btn" style="width: 100%; background: #007185;">Become a Seller</button>
                        <button onclick="signOut()" class="btn" style="width: 100%;">Sign Out</button>
                    `;
                }
                
                // Replace the sign out button
                const existingSignOut = userInfoDiv.querySelector('button');
                if (existingSignOut) {
                    existingSignOut.replaceWith(buttonsDiv);
                } else {
                    userInfoDiv.appendChild(buttonsDiv);
                }
                
                // Show modal
                document.getElementById('loginModal').style.display = 'block';
            })
            .catch((error) => {
                console.error('Error checking seller status:', error);
                showBasicProfile();
            });
    }
}

function showBasicProfile() {
    // Basic profile without seller check (fallback)
    document.getElementById('googleSignInSection').style.display = 'none';
    document.getElementById('authFormSection').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Profile';
    
    document.getElementById('userName').textContent = currentUser.displayName || 'User';
    document.getElementById('userEmail').textContent = currentUser.email;
    
    if (currentUser.photoURL) {
        document.getElementById('userPhoto').src = currentUser.photoURL;
        document.getElementById('userPhoto').style.display = 'block';
    } else {
        document.getElementById('userPhoto').style.display = 'none';
    }
    
    document.getElementById('loginModal').style.display = 'block';
}

function closeLogin() {
    document.getElementById('loginModal').style.display = 'none';
}

// ================================
// FORGOT PASSWORD FUNCTIONS
// ================================
function showForgotPassword() {
    closeLogin();
    document.getElementById('forgotPasswordModal').style.display = 'block';
}

function closeForgotPassword() {
    document.getElementById('forgotPasswordModal').style.display = 'none';
    document.getElementById('forgotEmail').value = '';
}

function handleForgotPassword(event) {
    event.preventDefault();
    const email = document.getElementById('forgotEmail').value;
    
    auth.sendPasswordResetEmail(email)
        .then(() => {
            alert('Password reset email sent! Check your inbox.');
            closeForgotPassword();
        })
        .catch((error) => {
            console.error('Password reset error:', error);
            alert('Error sending reset email: ' + error.message);
        });
}

// ================================
// PRODUCT MANAGEMENT FUNCTIONS
// ================================
function loadProductsFromFirebase() {
    db.collection('products').onSnapshot((snapshot) => {
        products = [];
        snapshot.forEach((doc) => {
            products.push({
                id: doc.id,
                ...doc.data()
            });
        });
        displayProducts();
    });
}

function displayProducts() {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    products.forEach(product => {
        const productCard = createProductCard(product);
        grid.appendChild(productCard);
    });
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    const reviews = product.reviews || [];
    const reviewCount = reviews.length;
    const avgRating = reviews.length > 0 
        ? reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length 
        : 0;
    
    const starsHTML = Array.from({length: 5}, (_, i) => {
        if (i < Math.floor(avgRating)) {
            return `<span class="star">★</span>`;
        } else {
            return `<span class="star empty">☆</span>`;
        }
    }).join('');
    
    // Truncate description - shorter for mobile
    const fullDescription = product.description || 'DESCRIPTION';
    const truncatedDescription = fullDescription.length > 60 
        ? fullDescription.substring(0, 60) + '...' 
        : fullDescription;
    
    // Don't truncate seller name - show full name
    const sellerInfo = product.sellerBusinessName 
        ? `SOLD BY: ${product.sellerBusinessName}`
        : '';
    
    // Calculate delivery with separate lines
    let deliveryHTML = '';
    if (product.knutsfordDelivery || product.taraDelivery) {
        let deliveryLines = [];
        
        if (product.knutsfordDelivery) {
            const knutsfordDates = calculateDeliveryDates(product.knutsfordDelivery);
            if (knutsfordDates) {
                deliveryLines.push(`KNUTSFORD: ${knutsfordDates.start} - ${knutsfordDates.end}`);
            }
        }
        
        if (product.taraDelivery) {
            const taraDates = calculateDeliveryDates(product.taraDelivery);
            if (taraDates) {
                deliveryLines.push(`TARA: ${taraDates.start} - ${taraDates.end}`);
            }
        }
        
        if (deliveryLines.length > 0) {
            deliveryHTML = deliveryLines.map(line => `<p class="delivery-line">${line}</p>`).join('');
        }
    }

    // Stock information
    const stock = product.stock !== undefined ? product.stock : null;
    const lowStockAlert = product.lowStockAlert || 5;
    let stockHTML = '';
    let stockStatus = '';
    
    if (stock === null) {
        // For products without stock tracking, show as available
        stockHTML = '<p class="stock-info in-stock" style="color: #28a745; font-size: 0.8rem; margin: 0.3rem 0;">In Stock</p>';
        stockStatus = 'in-stock';
    } else if (stock <= 0) {
        stockHTML = '<p class="stock-info out-of-stock" style="color: #ff4757; font-weight: bold; font-size: 0.8rem; margin: 0.3rem 0;">OUT OF STOCK</p>';
        stockStatus = 'out-of-stock';
    } else if (stock <= lowStockAlert) {
        stockHTML = `<p class="stock-info low-stock" style="color: #ff8c00; font-weight: bold; font-size: 0.8rem; margin: 0.3rem 0;">ONLY ${stock} LEFT!</p>`;
        stockStatus = 'low-stock';
    } else if (stock < 20) {
        stockHTML = `<p class="stock-info normal-stock" style="color: #28a745; font-size: 0.8rem; margin: 0.3rem 0;">${stock} available</p>`;
        stockStatus = 'normal-stock';
    } else {
        stockHTML = '<p class="stock-info in-stock" style="color: #28a745; font-size: 0.8rem; margin: 0.3rem 0;">In Stock</p>';
        stockStatus = 'in-stock';
    }
    
    // Button text and state based on stock
    let buttonHTML = '';
    if (stock === 0) {
        buttonHTML = '<button class="add-to-cart out-of-stock" disabled style="background: #ccc; cursor: not-allowed;">Out of Stock</button>';
    } else {
        buttonHTML = `<button class="add-to-cart ${stockStatus}" data-product-id="${product.id}">Add to cart</button>`;
    }
    
    card.innerHTML = `
        <div class="product-image">
            <img src="${product.image || 'https://via.placeholder.com/200x250?text=No+Image'}" alt="${product.name || 'Product'}" onerror="this.src='https://via.placeholder.com/200x250?text=No+Image'">
        </div>
        <div class="product-details">
            <div class="product-header">
                <h3 class="product-title">${product.name || 'Untitled Product'}</h3>
                <p class="product-description">${truncatedDescription}</p>
                <div class="stars">${starsHTML} <span class="review-count">(${reviewCount})</span></div>
                ${deliveryHTML ? `<div class="delivery-info">${deliveryHTML}</div>` : ''}
                ${sellerInfo ? `<p class="seller-info" style="margin-bottom: 1rem;">${sellerInfo}</p>` : ''}
                ${stockHTML}
                ${product.category === 'clothing' && product.sizes && product.sizes.length > 0 ? 
                `<p style="color: #666; font-size: 0.8rem; margin: 0.2rem 0 1rem 0;">Sizes: ${product.sizes.join(', ')}</p>` : ''}
                <div class="product-price" style="margin-bottom: 0.5rem;">$${formatPrice(product.price || 0)}</div>
                <div style="text-align: center; margin-bottom: 0;">
                    ${buttonHTML}
                </div>
            </div>
        </div>
    `;
    
    // Add opacity overlay for out of stock products
    if (stock === 0) {
        card.style.opacity = '0.7';
        card.style.position = 'relative';
    }
    
    // Add click event to the entire card first
    card.addEventListener('click', function(e) {
        // Check if click is NOT on add-to-cart button or its children
        if (!e.target.closest('.add-to-cart')) {
            showProductDetail(product);
        }
    });
    
    // Then add click event to the button with event stopping (only if not out of stock)
    const addToCartBtn = card.querySelector('.add-to-cart:not([disabled])');
    if (addToCartBtn) {
        addToCartBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            addToCart(product.id);
            return false;
        });
    }
    
    return card;
}

function searchProducts() {
    const searchInput = document.querySelector('.search-bar');
    const searchTerm = searchInput.value.toLowerCase();
    const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) || 
        product.description.toLowerCase().includes(searchTerm) ||
        (product.sellerBusinessName && product.sellerBusinessName.toLowerCase().includes(searchTerm))
    );
    
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';
    
    filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        grid.appendChild(productCard);
    });
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No products or stores found matching your search.</div>';
    }
}

function filterByCategory(category) {
    currentCategory = category;
    
    // Update active button
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#ffd700';
        btn.style.color = '#333';
    });
    
    event.target.classList.add('active');
    event.target.style.background = '#333';
    event.target.style.color = '#ffd700';
    
    // Filter products
    displayFilteredProducts(category);
}

function displayFilteredProducts(category) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';

    let filteredProducts = products;
    if (category !== 'all') {
        filteredProducts = products.filter(product => 
            product.category && product.category.toLowerCase() === category.toLowerCase()
        );
    }

    filteredProducts.forEach(product => {
        const productCard = createProductCard(product);
        grid.appendChild(productCard);
    });
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No products found in this category.</div>';
    }
}

// ================================
// PRODUCT DETAIL VIEW FUNCTIONS
// ================================
function showProductDetail(product) {
    let detailView = document.getElementById('productDetailView');
    if (!detailView) {
        detailView = document.createElement('div');
        detailView.id = 'productDetailView';
        detailView.className = 'product-detail-view';
        document.body.appendChild(detailView);
    }
    
    const reviews = product.reviews || [];
    const avgRating = reviews.length > 0 
        ? reviews.reduce((sum, review) => sum + review.rating, 0) / reviews.length 
        : 0;
    
    const starsHTML = Array.from({length: 5}, (_, i) => {
        const starClass = i < Math.floor(avgRating) ? 'star' : 'star empty';
        return `<span class="${starClass}">★</span>`;
    }).join('');
    
    detailView.innerHTML = `
        <!-- Header -->
        <div class="header-lime-bar"></div>
        <header class="header">
            <div class="header-top">
                <div class="header-content">
                    <!-- Profile Section - Left -->
                    <div class="profile-section" onclick="showLogin()">
                        <div class="profile-avatar" id="detailProfileAvatar">W</div>
                        <button class="btn profile-btn" id="detailSignInBtn">PROFILE</button>
                    </div>

                    <div class="logo">WEB VTEC</div>
                    
                    <!-- Sell Button - Right -->
                    <button class="sell-btn-clean" onclick="closeProductDetail()">
                        <div class="sell-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 2.8l6 6V20h-2v-6H8v6H6v-8.2l6-6z"/>
                            </svg>
                        </div>
                        <span id="sellerBtnText">SELL</span>
                    </button>
                </div>

                <div class="header-separator"></div>
            </div>

            <!-- Categories Section -->
<div class="categories-section" style="padding: 0.2rem 5px; margin-bottom: 0.25rem;">
    <div class="categories-scroll" style="display: flex; gap: 0.8rem; overflow-x: auto; padding: 0.3rem 0; scrollbar-width: none; -ms-overflow-style: none;">
        <button class="category-btn ${currentCategory === 'all' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('all')" style="background: ${currentCategory === 'all' ? '#333' : '#ffd700'}; color: ${currentCategory === 'all' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">All</button>
        <button class="category-btn ${currentCategory === 'electronics' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('electronics')" style="background: ${currentCategory === 'electronics' ? '#333' : '#ffd700'}; color: ${currentCategory === 'electronics' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 90px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Electronics</button>
        <button class="category-btn ${currentCategory === 'clothing' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('clothing')" style="background: ${currentCategory === 'clothing' ? '#333' : '#ffd700'}; color: ${currentCategory === 'clothing' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 80px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Clothing</button>
        <button class="category-btn ${currentCategory === 'home' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('home')" style="background: ${currentCategory === 'home' ? '#333' : '#ffd700'}; color: ${currentCategory === 'home' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Home</button>
        <button class="category-btn ${currentCategory === 'beauty' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('beauty')" style="background: ${currentCategory === 'beauty' ? '#333' : '#ffd700'}; color: ${currentCategory === 'beauty' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Beauty</button>
        <button class="category-btn ${currentCategory === 'sports' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('sports')" style="background: ${currentCategory === 'sports' ? '#333' : '#ffd700'}; color: ${currentCategory === 'sports' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Sports</button>
        <button class="category-btn ${currentCategory === 'books' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('books')" style="background: ${currentCategory === 'books' ? '#333' : '#ffd700'}; color: ${currentCategory === 'books' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Books</button>
        <button class="category-btn ${currentCategory === 'toys' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('toys')" style="background: ${currentCategory === 'toys' ? '#333' : '#ffd700'}; color: ${currentCategory === 'toys' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Toys</button>
        <button class="category-btn ${currentCategory === 'automotive' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('automotive')" style="background: ${currentCategory === 'automotive' ? '#333' : '#ffd700'}; color: ${currentCategory === 'automotive' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 95px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Automotive</button>
        <button class="category-btn ${currentCategory === 'jewelry' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('jewelry')" style="background: ${currentCategory === 'jewelry' ? '#333' : '#ffd700'}; color: ${currentCategory === 'jewelry' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 80px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Jewelry</button>
        <button class="category-btn ${currentCategory === 'health' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('health')" style="background: ${currentCategory === 'health' ? '#333' : '#ffd700'}; color: ${currentCategory === 'health' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Health</button>
        <button class="category-btn ${currentCategory === 'music' ? 'active' : ''}" onclick="closeProductDetail(); filterByCategory('music')" style="background: ${currentCategory === 'music' ? '#333' : '#ffd700'}; color: ${currentCategory === 'music' ? '#ffd700' : '#333'}; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; white-space: nowrap; cursor: pointer; font-weight: bold; min-width: 70px; font-size: 0.85rem; text-align: center; display: flex; align-items: center; justify-content: center;">Music</button>
    </div>
</div>

            <!-- Search Container - Center -->
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search products..." onkeyup="searchProducts()">
                <button class="search-btn" onclick="searchProducts()">🔍</button>
            </div>
        </header>

        <div style="padding: 20px; margin-top: 10px;">
            <h2 style="text-align: left; color: #333; margin: 0.5rem 0; font-size: 1.5rem; font-weight: bold; text-transform: uppercase;">${product.name}</h2>
            
            <div class="stars" style="justify-content: flex-start; margin-bottom: 1rem;">
                ${starsHTML} <span style="color: #666; margin-left: 10px;">(${reviews.length})</span>
            </div>
            
            <div class="product-gallery">
                <div class="photo-gallery">
                    <div class="photo-container" id="photoContainer-${product.id}">
                        ${(product.images || [product.image]).filter(img => img).map(img => 
                            `<div class="photo-slide"><img src="${img}" alt="${product.name}"></div>`
                        ).join('')}
                    </div>
                    ${(product.images || []).length > 1 ? `
                        <div class="photo-nav">
                            ${(product.images || [product.image]).filter(img => img).map((_, i) => 
                                `<div class="photo-dot ${i === 0 ? 'active' : ''}" onclick="goToPhoto('${product.id}', ${i})"></div>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                <div class="detail-price" style="margin: 0;">$${formatPrice(product.price || 0)}</div>
            </div>
            
            <div class="detail-actions">
                <button class="detail-add-to-cart" onclick="addToCart('${product.id}'); closeProductDetail();">Add to Cart</button>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3 style="color: #333;">Product Details</h3>
                <p style="color: #666;">${product.description || 'Detailed product information goes here.'}</p>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3 style="color: #333;">Customer Reviews</h3>
                <div class="reviews-list">
                    ${reviews.map(review => `
                        <div class="review-item" style="background: #f9f9f9; color: #333;">
                            <div class="review-header">
                                <span class="reviewer-name" style="color: #333;">${review.name}</span>
                                <span class="review-stars" style="color: #ffa500;">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
                            </div>
                            <p>${review.comment}</p>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    detailView.classList.add('active');
    setTimeout(() => {
        if (typeof initializePhotoGallery === 'function') {
            initializePhotoGallery(product.id);
        }
        if (typeof updateDetailPageAuth === 'function') {
            updateDetailPageAuth();
        }
    }, 200);
}

function closeProductDetail() {
    const detailView = document.getElementById('productDetailView');
    if (detailView) {
        detailView.classList.remove('active');
    }
}

function updateDetailPageAuth() {
    const detailSignInBtn = document.getElementById('detailSignInBtn');
    const detailProfileAvatar = document.getElementById('detailProfileAvatar');
    
    if (detailSignInBtn && detailProfileAvatar) {
        if (currentUser) {
            const displayName = currentUser.displayName || 'User';
            const firstName = displayName.split(' ')[0];
            detailSignInBtn.innerHTML = `${firstName}`;
            
            // Update avatar
            if (currentUser.photoURL) {
                detailProfileAvatar.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
            } else {
                const initial = displayName.charAt(0).toUpperCase() || currentUser.email.charAt(0).toUpperCase();
                detailProfileAvatar.innerHTML = initial;
            }
        } else {
            detailSignInBtn.innerHTML = 'Sign In';
            detailProfileAvatar.innerHTML = 'W';
        }
    }
}

function shareProduct(productId, productName) {
    const productUrl = `${window.location.origin}${window.location.pathname}?product=${productId}`;
    const shareText = `Check out ${productName} on WEBVTEC!`;
    
    if (navigator.share) {
        // Use native share API (mobile devices)
        navigator.share({
            title: productName,
            text: shareText,
            url: productUrl
        });
    } else {
        // Fallback: copy link to clipboard
        navigator.clipboard.writeText(productUrl).then(() => {
            alert('Product link copied to clipboard!');
        }).catch(() => {
            // If clipboard fails, show the link
            prompt('Copy this link to share:', productUrl);
        });
    }
}

// ================================
// CART MANAGEMENT FUNCTIONS
// ================================
function addToCart(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return false;
    
    // Check stock availability - only if stock tracking is enabled
    if (product.stock !== undefined && product.stock <= 0) {
        alert('This product is out of stock');
        return false;
    }
    
    const existingItem = cart.find(item => item.id === productId);
    const currentQuantity = existingItem ? existingItem.quantity : 0;
    
    // Only check stock limits if stock tracking is enabled
    if (product.stock !== undefined && currentQuantity >= product.stock) {
        alert(`Only ${product.stock} items available in stock`);
        return false;
    }
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({ 
            ...product, 
            quantity: 1,
            sellerId: product.sellerId,
            sellerBusinessName: product.sellerBusinessName || 'Unknown Seller'
        });
    }
    
    updateCartCount();
    showCartNotification(product.name);
    return false;
}

function updateCartCount() {
    const count = cart.reduce((total, item) => total + item.quantity, 0);
    const cartBadge = document.getElementById('cartCountFloat');
    if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function showCartNotification(productName) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #ffd700, #ffed4a);
        color: #333;
        padding: 1rem;
        border-radius: 10px;
        z-index: 3000;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    `;
    notification.textContent = `${productName} added to cart!`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showCart() {
    if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
    }
    
    const groupedCart = groupCartBySeller();
    let cartHTML = '<h3 style="color: #ffd700; margin-bottom: 1.5rem;">Your Cart</h3>';
    let grandTotal = 0;
    
    Object.entries(groupedCart).forEach(([sellerId, sellerGroup]) => {
        cartHTML += `
            <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid #ffd700;">
                <h4 style="color: #ffd700; margin-bottom: 0.5rem;">From: ${sellerGroup.sellerName}</h4>
        `;
        
        sellerGroup.items.forEach(item => {
            const itemTotal = item.price * item.quantity;
            cartHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div>
                        <span style="font-weight: bold;">${item.name}</span>
                        <span style="color: #ccc; margin-left: 10px;">x${item.quantity}</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span>JMD $${formatJMDPrice(itemTotal)}</span>
                        <button onclick="removeFromCart('${item.id}')" style="background: #ff4757; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Remove</button>
                    </div>
                </div>
            `;
        });
        
        cartHTML += `
                <div style="text-align: right; margin-top: 0.5rem;">
                    <strong style="color: #ffd700;">Subtotal: JMD $${formatJMDPrice(sellerGroup.subtotal)}</strong>
                </div>
            </div>
        `;
        
        grandTotal += sellerGroup.subtotal;
    });
    
    const usdTotal = convertJMDToUSD(grandTotal);
    
    cartHTML += `
        <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
            <h3 style="color: #ffd700; margin: 0;">Total: JMD $${formatJMDPrice(grandTotal)}</h3>
            <p style="color: #ccc; font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                PayPal will charge: USD $${formatPrice(parseFloat(usdTotal))} (${Object.keys(groupedCart).length} seller(s))
            </p>
        </div>
        <button onclick="proceedToCheckout()" class="btn" style="width: 100%; margin-top: 1rem;">Proceed to Checkout</button>
    `;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            ${cartHTML}
        </div>
    `;
    document.body.appendChild(modal);
}
    
function removeFromCart(productId) {
    const index = cart.findIndex(item => item.id === productId);
    if (index !== -1) {
        cart.splice(index, 1);
        updateCartCount();
        
        // Refresh cart display
        const modal = document.querySelector('.modal');
        if (modal) {
            modal.remove();
            showCart();
        }
    }
}

function groupCartBySeller() {
    const grouped = {};
    
    cart.forEach(item => {
        const sellerId = item.sellerId;
        const sellerName = item.sellerBusinessName || 'Unknown Seller';
        
        if (!grouped[sellerId]) {
            grouped[sellerId] = {
                sellerName: sellerName,
                items: [],
                subtotal: 0
            };
        }
        
        grouped[sellerId].items.push(item);
        grouped[sellerId].subtotal += item.price * item.quantity;
    });
    
    return grouped;
}

// ================================
// CHECKOUT & ORDER FUNCTIONS
// ================================
function proceedToCheckout() {
    if (!currentUser) {
        alert('Please sign in to proceed with checkout');
        return;
    }
    
    if (cart.length === 0) {
        alert('Your cart is empty');
        return;
    }
    
    // Show shipping form
    showShippingForm();
}

function showShippingForm() {
    const groupedCart = groupCartBySeller();
    const totalAmount = Object.values(groupedCart).reduce((sum, group) => sum + group.subtotal, 0);
    const usdAmount = convertJMDToUSD(totalAmount);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 1rem;">Delivery Information</h2>
            
            <!-- Delivery Location Selection -->
            <div class="form-group">
                <label>Select Delivery Location:</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <button type="button" id="knutsfordBtn" onclick="selectDeliveryLocation('knutsford')" style="flex: 1; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; background: white; color: #333; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                        KNUTSFORD
                    </button>
                    <button type="button" id="taraBtn" onclick="selectDeliveryLocation('tara')" style="flex: 1; padding: 0.8rem; border: 2px solid #ddd; border-radius: 8px; background: white; color: #333; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                        TARA
                    </button>
                </div>
                <p style="color: #ccc; font-size: 0.8rem; margin: 0.5rem 0 0 0;">Please select your preferred delivery location first</p>
            </div>

            <!-- Dynamic Form Container -->
            <div id="dynamicFormContainer" style="display: none;">
                <form id="shippingForm" onsubmit="completeOrder(event)">
                    <input type="hidden" id="deliveryLocation" required>
                    
                    <!-- Form fields will be inserted here dynamically -->
                    <div id="formFields"></div>
                    
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h3 style="color: #ffd700; margin: 0 0 0.5rem 0;">Order Summary</h3>
                        <p style="color: #ccc; margin: 0;">Items from ${Object.keys(groupedCart).length} seller(s)</p>
                        <h4 style="color: #ffd700; margin: 0.5rem 0 0 0;">Total: JMD $${formatJMDPrice(totalAmount)}</h4>
                        <p style="color: #ccc; font-size: 0.8rem; margin: 0.3rem 0 0 0;">PayPal will charge: USD $${formatPrice(parseFloat(usdAmount))}</p>
                        <p style="color: #999; font-size: 0.75rem; margin: 0.2rem 0 0 0;">Exchange rate: 1 JMD = ${JMD_TO_USD_RATE} USD</p>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Complete Order</button>
                </form>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

    
function selectDeliveryLocation(location) {
    // Update hidden input
    document.getElementById('deliveryLocation').value = location;
    
    // Reset button styles
    document.getElementById('knutsfordBtn').style.borderColor = '#ddd';
    document.getElementById('knutsfordBtn').style.background = 'white';
    document.getElementById('knutsfordBtn').style.color = '#333';
    
    document.getElementById('taraBtn').style.borderColor = '#ddd';
    document.getElementById('taraBtn').style.background = 'white';
    document.getElementById('taraBtn').style.color = '#333';
    
    // Highlight selected button
    const selectedBtn = document.getElementById(location + 'Btn');
    selectedBtn.style.borderColor = '#007185';
    selectedBtn.style.background = '#007185';
    selectedBtn.style.color = 'white';
    
    // Show form container and populate form fields
    document.getElementById('dynamicFormContainer').style.display = 'block';
    populateFormFields(location);
}

function populateFormFields(location) {
    const formContainer = document.getElementById('formFields');
    
    if (location === 'knutsford') {
        formContainer.innerHTML = `
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="shippingName" required>
            </div>
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" id="shippingPhone" required placeholder="e.g., 876-555-1234">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="shippingEmail" value="${currentUser?.email || ''}" required>
            </div>
            <div class="form-group">
                <label>Knutsford Pickup Location:</label>
                <select id="knutsfordPickupLocation" required>
                    <option value="">Select Pickup Location</option>
                    <option value="Knutsford Boulevard Main Gate">Knutsford Boulevard Main Gate</option>
                    <option value="Knutsford Express Terminal">Knutsford Express Terminal</option>
                    <option value="Knutsford Shopping Center">Knutsford Shopping Center</option>
                    <option value="Knutsford University Campus">Knutsford University Campus</option>
                    <option value="Knutsford Community Center">Knutsford Community Center</option>
                </select>
            </div>
        `;
    } else if (location === 'tara') {
        formContainer.innerHTML = `
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="shippingName" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="shippingEmail" value="${currentUser?.email || ''}" required>
            </div>
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" id="shippingPhone" required placeholder="e.g., 876-555-1234">
            </div>
            <div class="form-group">
                <label>Delivery Address:</label>
                <input type="text" id="shippingAddress" required placeholder="Enter your full delivery address">
            </div>
            <div class="form-group">
                <label>Parish:</label>
                <select id="shippingParish" required>
                    <option value="">Select Parish</option>
                    <option value="Kingston">Kingston</option>
                    <option value="St. Andrew">St. Andrew</option>
                    <option value="St. Thomas">St. Thomas</option>
                    <option value="Portland">Portland</option>
                    <option value="St. Mary">St. Mary</option>
                    <option value="St. Ann">St. Ann</option>
                    <option value="Trelawny">Trelawny</option>
                    <option value="St. James">St. James</option>
                    <option value="Hanover">Hanover</option>
                    <option value="Westmoreland">Westmoreland</option>
                    <option value="St. Elizabeth">St. Elizabeth</option>
                    <option value="Manchester">Manchester</option>
                    <option value="Clarendon">Clarendon</option>
                    <option value="St. Catherine">St. Catherine</option>
                </select>
            </div>
        `;
    }
}

    
async function completeOrder(event) {
    event.preventDefault();
    
    const deliveryLocation = document.getElementById('deliveryLocation').value;
    if (!deliveryLocation) {
        alert('Please select a delivery location');
        return;
    }
    
    const groupedCart = groupCartBySeller();
    const totalAmount = Object.values(groupedCart).reduce((sum, group) => sum + group.subtotal, 0);
    const mainOrderId = generateMainOrderId();
    
    // Collect shipping information
    let shippingAddress;
    if (deliveryLocation === 'knutsford') {
        const pickupLocation = document.getElementById('knutsfordPickupLocation').value;
        if (!pickupLocation) {
            alert('Please select a Knutsford pickup location');
            return;
        }
        
        shippingAddress = {
            name: document.getElementById('shippingName').value,
            email: document.getElementById('shippingEmail').value,
            phone: document.getElementById('shippingPhone').value,
            pickupLocation: pickupLocation,
            deliveryLocation: deliveryLocation.toUpperCase(),
            deliveryType: 'pickup'
        };
    } else {
        shippingAddress = {
            name: document.getElementById('shippingName').value,
            email: document.getElementById('shippingEmail').value,
            phone: document.getElementById('shippingPhone').value,
            address: document.getElementById('shippingAddress').value,
            parish: document.getElementById('shippingParish').value,
            deliveryLocation: deliveryLocation.toUpperCase(),
            deliveryType: 'home_delivery'
        };
    }
    
    // Create order data
    const orderData = {
    orderId: mainOrderId,
    buyerId: currentUser.uid,
    buyerEmail: currentUser.email,
    totalAmount: totalAmount, // JMD amount
    totalAmountUSD: parseFloat(convertJMDToUSD(totalAmount)), // USD amount for PayPal
    currency: 'JMD',
    paymentCurrency: 'USD',
    exchangeRate: JMD_TO_USD_RATE,
    status: 'pending_payment',
    createdAt: new Date().toISOString(),
    shippingAddress: shippingAddress,
    sellers: {}
};
    
    // Process each seller's items
    Object.entries(groupedCart).forEach(([sellerId, sellerGroup]) => {
        const orderNumber = generateOrderNumber(sellerId);
        
        orderData.sellers[sellerId] = {
            orderNumber: orderNumber,
            sellerName: sellerGroup.sellerName,
            items: sellerGroup.items.map(item => ({
                productId: item.id,
                productName: item.name,
                price: item.price,
                quantity: item.quantity,
                subtotal: item.price * item.quantity
            })),
            subtotal: sellerGroup.subtotal,
            status: 'pending_payment',
            deliveryLocation: deliveryLocation.toUpperCase(),
            deliveryType: shippingAddress.deliveryType
        };
    });
    
    // Show payment modal
    showPaymentModal(orderData);
}

// Generate unique order numbers for each seller
function generateOrderNumber(sellerId) {
    const timestamp = Date.now().toString().slice(-8);
    const sellerCode = sellerId.slice(0, 4).toUpperCase();
    return `WV${sellerCode}${timestamp}`;
}

function generateMainOrderId() {
    return `WVO${Date.now()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
}

async function saveOrderToFirestore(orderData) {
    try {
        // Save main order
        await db.collection('orders').doc(orderData.orderId).set(orderData);
        
        // Save individual seller orders for easier querying
        for (const [sellerId, sellerData] of Object.entries(orderData.sellers)) {
            await db.collection('sellerOrders').doc(sellerData.orderNumber).set({
                orderNumber: sellerData.orderNumber,
                mainOrderId: orderData.orderId,
                sellerId: sellerId,
                sellerName: sellerData.sellerName,
                buyerId: orderData.buyerId,
                buyerEmail: orderData.buyerEmail,
                items: sellerData.items,
                subtotal: sellerData.subtotal,
                status: sellerData.status,
                createdAt: orderData.createdAt,
                shippingAddress: orderData.shippingAddress
            });
        }
        
        return true;
    } catch (error) {
        console.error('Error saving order:', error);
        return false;
    }
}

function showPaymentModal(orderData) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 1rem;">Complete Payment</h2>
            
            <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h3 style="color: #ffd700; margin: 0 0 0.5rem 0;">Order Summary</h3>
                <p style="color: #ccc; margin: 0;">Total Amount: <strong>JMD $${orderData.totalAmount.toFixed(2)}</strong></p>
                <p style="color: #ccc; margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                    Delivery: ${orderData.shippingAddress.deliveryLocation}
                </p>
            </div>
            
            <div id="paypal-button-container"></div>
            
            <p style="color: #ccc; font-size: 0.8rem; text-align: center; margin-top: 1rem;">
                Secure payment powered by PayPal
            </p>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Initialize PayPal
    processPayPalPayment(
        orderData,
        (details) => {
            // Success
            modal.remove();
            cart = [];
            updateCartCount();
            alert(`Payment successful! Order #${orderData.orderId} has been placed.`);
        },
        (error) => {
            // Error
            console.error('Payment error:', error);
            alert('Payment failed. Please try again.');
        }
    );
}

function processPayPalPayment(orderData, onSuccess, onError) {
    // Convert JMD total to USD for PayPal
    const usdAmount = convertJMDToUSD(orderData.totalAmount);
    
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: usdAmount,
                        currency_code: 'USD'
                    },
                    description: `WEBVTEC Order #${orderData.orderId} (JMD $${orderData.totalAmount.toFixed(2)})`
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Store both JMD and USD amounts
                details.jmdAmount = orderData.totalAmount;
                details.usdAmount = parseFloat(usdAmount);
                details.exchangeRate = JMD_TO_USD_RATE;
                
                handleSuccessfulPayment(details, orderData);
                onSuccess(details);
            });
        },
        onError: function(err) {
            console.error('PayPal payment error:', err);
            onError(err);
        }
    }).render('#paypal-button-container');
}

function handleSuccessfulPayment(paymentDetails, orderData) {
    // Update order with payment information
    const paymentData = {
        paymentId: paymentDetails.id,
        paymentStatus: 'completed',
        paymentMethod: 'paypal',
        paymentDate: new Date().toISOString(),
        paymentDetails: paymentDetails
    };
    
    // Update order in Firestore
    db.collection('orders').doc(orderData.orderId).update({
        payment: paymentData,
        status: 'paid'
    });
    
    // Process cash splitting
    processCashSplitting(orderData, paymentDetails);
}

function processCashSplitting(orderData, paymentDetails) {
    const platformFeeRate = 0.05; // 5% platform fee
    const paypalFeeRate = 0.029; // PayPal fee ~2.9%
    
    Object.entries(orderData.sellers).forEach(([sellerId, sellerData]) => {
        const grossAmount = sellerData.subtotal;
        const platformFee = grossAmount * platformFeeRate;
        const paypalFee = grossAmount * paypalFeeRate;
        const netAmount = grossAmount - platformFee - paypalFee;
        
        // Update seller's balance
        db.collection('sellers').doc(sellerId).get().then(doc => {
            if (doc.exists) {
                const seller = doc.data();
                const newBalance = (seller.availableBalance || 0) + netAmount;
                
                // Update seller balance and sales history
                db.collection('sellers').doc(sellerId).update({
                    availableBalance: newBalance,
                    totalSales: (seller.totalSales || 0) + grossAmount,
                    salesHistory: firebase.firestore.FieldValue.arrayUnion({
                        orderId: orderData.orderId,
                        orderNumber: sellerData.orderNumber,
                        grossAmount: grossAmount,
                        platformFee: platformFee,
                        paypalFee: paypalFee,
                        netAmount: netAmount,
                        date: new Date().toISOString(),
                        status: 'completed'
                    })
                });
                
                // Send earnings notification
                sendEarningsNotification(seller, sellerData.orderNumber, netAmount);
            }
        });
    });
}

function sendEarningsNotification(seller, orderNumber, earnings) {
    // This would trigger a Firebase function to send email
    db.collection('emailTriggers').add({
        type: 'earnings_notification',
        to: seller.email,
        sellerName: seller.businessName,
        orderNumber: orderNumber,
        earnings: earnings,
        timestamp: new Date().toISOString()
    });
}

// ================================
// SELLER MANAGEMENT FUNCTIONS
// ================================
function showSellerSignup() {
    document.getElementById('sellerModal').style.display = 'block';
    populateDatePickers();
}

function closeSellerSignup() {
    document.getElementById('sellerModal').style.display = 'none';
}

function signUpSellerWithGoogle() {
    auth.signInWithPopup(googleProvider)
        .then((result) => {
            const user = result.user;
            // Check if user already exists as seller
            return db.collection('sellers').doc(user.uid).get()
                .then((doc) => {
                    if (!doc.exists) {
                        // New seller - collect additional info
                        collectSellerInfo(user);
                    } else {
                        // Already a seller
                        currentUser = user;
                        updateAuthUI();
                        closeSellerSignup();
                        alert('Welcome back! You are already registered as a seller.');
                        showSellerDashboard();
                    }
                });
        })
        .catch((error) => {
            console.error('Google seller sign-up error:', error);
            alert('Error with Google sign-up: ' + error.message);
        });
}

function collectSellerInfo(user) {
    // Pre-fill form with Google data
    const names = (user.displayName || '').split(' ');
    document.getElementById('sellerFirstName').value = names[0] || '';
    document.getElementById('sellerLastName').value = names.slice(1).join(' ') || '';
    document.getElementById('sellerEmail').value = user.email || '';
    
    // Hide Google button, show message
    const googleBtn = document.querySelector('#sellerModal .google-btn');
    if (googleBtn) {
        googleBtn.style.display = 'none';
    }
    
    // Add notice
    const form = document.getElementById('sellerSignupForm');
    const notice = document.createElement('div');
    notice.style.cssText = 'background: rgba(40, 167, 69, 0.1); padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid rgba(40, 167, 69, 0.3);';
    notice.innerHTML = '<p style="color: #28a745; font-size: 0.85rem; margin: 0;">Google account connected! Please complete the seller information below.</p>';
    form.insertBefore(notice, form.firstChild);
    
    // Store user temporarily
    window.pendingSellerUser = user;
}

function handleSellerSignup(event) {
    event.preventDefault();
    
    // Get date of birth
    const month = document.getElementById('sellerMonth').value;
    const day = document.getElementById('sellerDay').value;
    const year = document.getElementById('sellerYear').value;
    
    if (!month || !day || !year) {
        alert('Please select your complete date of birth');
        return;
    }
    
    const dateOfBirth = `${year}-${month}-${day}`;
    
    const formData = {
        firstName: document.getElementById('sellerFirstName').value,
        lastName: document.getElementById('sellerLastName').value,
        dateOfBirth: dateOfBirth,
        email: document.getElementById('sellerEmail').value,
        password: document.getElementById('sellerPassword').value,
        phone: document.getElementById('sellerPhone').value,
        businessName: document.getElementById('sellerBusiness').value
    };
    
    // Validate required fields
    if (!formData.firstName || !formData.lastName || !formData.email || 
        !formData.password || !formData.phone || !formData.businessName) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (formData.password.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
    }
    
    // Show payment modal for seller subscription
    showSellerPaymentModal(formData);
    }


function showSellerPaymentModal(formData) {
    const monthlyFeeJMD = 2300;
    const monthlyFeeUSD = convertJMDToUSD(monthlyFeeJMD);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 1rem;">SUBSCRIPTION PAYMENT</h2>
            
            <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <h4 style="color: #ffd700; margin: 0.5rem 0;">Monthly Fee: JMD $2,300.00</h4>
                <p style="color: #ccc; font-size: 0.8rem; margin: 0.3rem 0 0 0;">PayPal will charge: USD $${monthlyFeeUSD}</p>
            </div>
            
            <div style="background: rgba(255, 99, 71, 0.1); padding: 0.8rem; border-radius: 6px; margin: 1rem 0; border: 1px solid rgba(255, 99, 71, 0.3);">
                <p style="color: #40F615; font-size: 0.85rem; margin: 0;">
                    <strong>Important:</strong> This is a monthly recurring subscription. You will be charged JMD $2,300 every month. Cancel anytime from your seller dashboard.
                </p>
            </div>
            
            <!-- PayPal Button Container -->
            <div id="seller-paypal-button-container" style="margin: 1.5rem 0;"></div>
            
            <p style="color: #ccc; font-size: 0.8rem; text-align: center; margin-top: 1rem;">
                Secure payment powered by PayPal • Cancel anytime from dashboard
            </p>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Wait for modal to be added to DOM, then initialize PayPal
    setTimeout(() => {
        processSellerSubscriptionPayment(formData, modal);
    }, 100);
}
    
function processSellerSubscriptionPayment(formData, modal) {
    const monthlyFeeJMD = 2300;
    const subscriptionAmount = convertJMDToUSD(monthlyFeeJMD);
    
    // Check if PayPal is loaded
    if (typeof paypal === 'undefined') {
        document.getElementById('seller-paypal-button-container').innerHTML = 
            '<p style="color: #ff4757; text-align: center;">PayPal failed to load. Please refresh the page and try again.</p>';
        return;
    }
    
    // Clear any existing buttons
    document.getElementById('seller-paypal-button-container').innerHTML = '';
    
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: subscriptionAmount,
                        currency_code: 'USD'
                    },
                    description: `WEBVTEC Premium Seller Subscription - ${formData.businessName}`
                }],
                application_context: {
                    shipping_preference: 'NO_SHIPPING'
                }
            });
        },
        onApprove: function(data, actions) {
            // Show processing message
            document.getElementById('seller-paypal-button-container').innerHTML = 
                '<p style="color: #28a745; text-align: center;">Processing payment...</p>';
                
            return actions.order.capture().then(function(details) {
                console.log('Payment successful:', details);
                handleSellerSubscriptionSuccess(details, formData, modal);
            });
        },
        onError: function(err) {
            console.error('Seller subscription payment error:', err);
            document.getElementById('seller-paypal-button-container').innerHTML = 
                '<p style="color: #ff4757; text-align: center;">Payment failed. Please try again.</p>';
        },
        onCancel: function(data) {
            console.log('Payment cancelled');
            document.getElementById('seller-paypal-button-container').innerHTML = 
                '<p style="color: #ffc107; text-align: center;">Payment cancelled. Try again when ready.</p>';
        },
        style: {
            color: 'blue',
            shape: 'rect',
            label: 'paypal',
            height: 45,
            layout: 'vertical'
        }
    }).render('#seller-paypal-button-container').catch(function(err) {
        console.error('PayPal render error:', err);
        document.getElementById('seller-paypal-button-container').innerHTML = 
            '<p style="color: #ff4757; text-align: center;">Failed to load payment options. Please refresh and try again.</p>';
    });
    }

function handleSellerSubscriptionSuccess(paymentDetails, formData, modal) {
    // Check if this is a Google sign-up completion
    if (window.pendingSellerUser) {
        // Complete Google seller registration with payment
        completeGoogleSellerRegistrationWithPayment(formData, paymentDetails, modal);
    } else {
        // Regular email/password registration with payment
        createEmailSellerAccountWithPayment(formData, paymentDetails, modal);
    }
}

function createEmailSellerAccountWithPayment(formData, paymentDetails, modal) {
    auth.createUserWithEmailAndPassword(formData.email, formData.password)
        .then((result) => {
            const user = result.user;
            return completeSellerRegistrationWithPayment(user, formData, paymentDetails);
        })
        .then(() => {
            modal.remove();
            alert('Premium seller account created successfully! Your subscription is now active.');
            setTimeout(() => showSellerDashboard(), 1000);
        })
        .catch((error) => {
            console.error('Email seller signup error:', error);
            alert('Error creating seller account: ' + error.message);
        });
}

function completeGoogleSellerRegistrationWithPayment(formData, paymentDetails, modal) {
    const user = window.pendingSellerUser;
    completeSellerRegistrationWithPayment(user, formData, paymentDetails)
        .then(() => {
            delete window.pendingSellerUser;
            modal.remove();
            alert('Premium seller account created successfully! Your subscription is now active.');
            setTimeout(() => showSellerDashboard(), 1000);
        })
        .catch((error) => {
            console.error('Google seller signup error:', error);
            alert('Error creating seller account: ' + error.message);
        });
}


function completeSellerRegistrationWithPayment(user, formData, paymentDetails) {
    const monthlyFeeJMD = 2300;
    const subscriptionStart = new Date();
    const subscriptionEnd = new Date();
    subscriptionEnd.setMonth(subscriptionEnd.getMonth() + 1); // Add 1 month
    
    return user.updateProfile({
        displayName: `${formData.firstName} ${formData.lastName}`
    }).then(() => {
        return db.collection('sellers').doc(user.uid).set({
            uid: user.uid,
            firstName: formData.firstName,
            lastName: formData.lastName,
            dateOfBirth: formData.dateOfBirth,
            email: formData.email,
            phone: formData.phone,
            businessName: formData.businessName,
            
            // Subscription details
            subscriptionStatus: 'active',
            subscriptionTier: 'premium',
            monthlyFee: monthlyFeeJMD,
            monthlyFeeUSD: parseFloat(convertJMDToUSD(monthlyFeeJMD)),
            subscriptionStart: subscriptionStart.toISOString(),
            subscriptionEnd: subscriptionEnd.toISOString(),
            joinedDate: new Date().toISOString(),
            autoRenew: true,
            
            // Payment details
            lastPayment: {
                paypalTransactionId: paymentDetails.id,
                amount: monthlyFeeJMD, // JMD
                amountUSD: parseFloat(convertJMDToUSD(monthlyFeeJMD)),
                paymentDate: new Date().toISOString(),
                status: 'completed',
                exchangeRate: JMD_TO_USD_RATE
            },
            
            isSeller: true,
            products: [],
            
            // PayPal information (to be completed later)
            paypalEmail: '',
            paypalVerified: false,
            paymentSetupComplete: false,
            
            // Financial tracking
            totalSales: 0,
            pendingPayouts: 0,
            availableBalance: 0,
            lastPayoutDate: null,
            salesHistory: [],
            payoutHistory: [],
            subscriptionHistory: [{
                paypalTransactionId: paymentDetails.id,
                amount: monthlyFeeJMD,
                amountUSD: parseFloat(convertJMDToUSD(monthlyFeeJMD)),
                paymentDate: new Date().toISOString(),
                period: `${subscriptionStart.toISOString()} to ${subscriptionEnd.toISOString()}`,
                status: 'completed',
                exchangeRate: JMD_TO_USD_RATE
            }]
        });
    }).then(() => {
        currentUser = user;
        updateAuthUI();
        closeSellerSignup();
    });
                    }


    function checkSellerSubscriptionStatus() {
    if (!currentUser) return;
    
    db.collection('sellers').doc(currentUser.uid).get()
        .then((doc) => {
            if (doc.exists) {
                const seller = doc.data();
                const subscriptionEnd = new Date(seller.subscriptionEnd);
                const now = new Date();
                const daysUntilExpiry = Math.ceil((subscriptionEnd - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry <= 7 && daysUntilExpiry > 0) {
                    showSubscriptionRenewalReminder(daysUntilExpiry, seller.monthlyFee);
                } else if (daysUntilExpiry <= 0) {
                    showSubscriptionExpiredNotice();
                }
            }
        });
}

function showSubscriptionRenewalReminder(days, monthlyFee) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff9800;
        color: white;
        padding: 1rem;
        border-radius: 8px;
        z-index: 3000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    notification.innerHTML = `
        <strong>Subscription Renewal</strong><br>
        Your premium subscription expires in ${days} day(s).<br>
        Monthly fee: JMD $${monthlyFee}<br>
        <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">OK</button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 10000);
}
function createEmailSellerAccount(formData) {
    auth.createUserWithEmailAndPassword(formData.email, formData.password)
        .then((result) => {
            const user = result.user;
            return completeSellerRegistration(user, formData);
        })
        .catch((error) => {
            console.error('Email seller signup error:', error);
            alert('Error creating seller account: ' + error.message);
        });
}

function completeGoogleSellerRegistration(formData) {
    const user = window.pendingSellerUser;
    completeSellerRegistration(user, formData)
        .then(() => {
            delete window.pendingSellerUser;
        });
}

function debugSellerPayment() {
    console.log('PayPal loaded:', typeof paypal !== 'undefined');
    console.log('Firebase loaded:', typeof firebase !== 'undefined');
    console.log('Exchange rate:', JMD_TO_USD_RATE);
    console.log('Test conversion JMD 2300 to USD:', convertJMDToUSD(2300));
    
    if (typeof paypal === 'undefined') {
        console.error('PayPal SDK not loaded - check your Client ID');
    }
}

function completeSellerRegistration(user, formData) {
    return user.updateProfile({
        displayName: `${formData.firstName} ${formData.lastName}`
    }).then(() => {
        return db.collection('sellers').doc(user.uid).set({
            uid: user.uid,
            firstName: formData.firstName,
            lastName: formData.lastName,
            dateOfBirth: formData.dateOfBirth,
            email: formData.email,
            phone: formData.phone,
            businessName: formData.businessName,
            subscriptionStatus: 'active',
            monthlyFee: 25,
            joinedDate: new Date().toISOString(),
            isSeller: true,
            products: [],
            // PayPal payment information
            paypalEmail: '',
            paypalVerified: false,
            paymentSetupComplete: false,
            // Financial tracking
            totalSales: 0,
            pendingPayouts: 0,
            availableBalance: 0,
            lastPayoutDate: null,
            salesHistory: [],
            payoutHistory: []
        });
    }).then(() => {
        currentUser = user;
        updateAuthUI();
        closeSellerSignup();
        alert('Seller account created successfully! Please complete your PayPal setup in your dashboard.');
        setTimeout(() => showSellerDashboard(), 1000);
    });
}

function populateDatePickers() {
    const daySelect = document.getElementById('sellerDay');
    const yearSelect = document.getElementById('sellerYear');
    
    // Populate days
    for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i.toString().padStart(2, '0');
        option.textContent = i;
        daySelect.appendChild(option);
    }
    
    // Populate years (from 1950 to current year - 13 for minimum age)
    const currentYear = new Date().getFullYear();
    const minYear = currentYear - 13;
    for (let i = minYear; i >= 1950; i--) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        yearSelect.appendChild(option);
    }
}

function handleSellerButton() {
    if (!currentUser) {
        showSellerSignup();
        return;
    }
    
    // Check if user is already a seller
    db.collection('sellers').doc(currentUser.uid).get()
        .then((doc) => {
            if (doc.exists) {
                showSellerDashboard();
            } else {
                showSellerSignup();
            }
        })
        .catch((error) => {
            console.error('Error checking seller status:', error);
            showSellerSignup();
        });
}

function updateSellerButton() {
    const sellerBtn = document.getElementById('dynamicSellerBtn');
    const btnText = document.getElementById('sellerBtnText');
    
    if (currentUser) {
        db.collection('sellers').doc(currentUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    btnText.textContent = 'SELLER DASHBOARD';
                } else {
                    btnText.textContent = 'SELL ON WEB VTEC';
                }
            })
            .catch(() => {
                btnText.textContent = 'SELL ON WEB VTEC';
            });
    } else {
        btnText.textContent = 'SELL ON WEB VTEC';
    }
}

// ================================
// SELLER DASHBOARD FUNCTIONS
// ================================
function showSellerDashboard() {
    document.getElementById('sellerDashboardPage').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    if (currentUser) {
        db.collection('sellers').doc(currentUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    const sellerData = doc.data();
                    document.getElementById('sellerWelcome').textContent = `Welcome, ${sellerData.businessName}!`;
                    
                    // Check if PayPal setup is complete
                    if (!sellerData.paymentSetupComplete) {
                        showPayPalSetupNotification();
                    }
                    
                    updateFinancialOverview(sellerData);
                }
            });
    }
    
    loadDashboardOverview();
    loadDashboardProducts();
}

function closeSellerDashboardPage() {
    document.getElementById('sellerDashboardPage').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Clean up listeners to prevent memory leaks and duplicates
    if (window.sellerOrdersListener) {
        window.sellerOrdersListener();
        window.sellerOrdersListener = null;
    }
    
    // Remove PayPal notifications
    const paypalNotifications = document.querySelectorAll('.paypal-setup-notification');
    paypalNotifications.forEach(notification => notification.remove());
}

function showDashboardTab(tabName, event) {
    // Hide all tabs
    document.querySelectorAll('.dashboard-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.dashboard-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.color = '#666';
        btn.style.borderBottomColor = 'transparent';
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    
    // Activate clicked button
    if (event && event.target) {
        event.target.classList.add('active');
        event.target.style.color = '#007185';
        event.target.style.borderBottomColor = '#007185';
    }
    
    // Load tab-specific content
    if (tabName === 'my-products') {
        loadDashboardProducts();
    } else if (tabName === 'orders') {
        loadSellerOrders();
    }
}

// In the loadDashboardOverview function, replace the statistics HTML:
function loadDashboardOverview() {
    if (!currentUser) return;
    
    db.collection('products')
        .where('sellerId', '==', currentUser.uid)
        .onSnapshot(async (snapshot) => {
            const productCount = snapshot.size;
            const remaining = 50 - productCount;
            
            document.getElementById('totalProducts').textContent = `${productCount}/50`;
            
            // Add a progress indicator
            const progressElement = document.querySelector('.products-progress');
            if (progressElement) {
                progressElement.remove();
            }
            
            const overview = document.getElementById('overview-tab');
            const progressDiv = document.createElement('div');
            progressDiv.className = 'products-progress';
            progressDiv.style.cssText = 'text-align: center; margin: 1rem 0; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
            progressDiv.innerHTML = `
                <h4 style="margin: 0 0 0.5rem 0; color: #333;">Product Listings</h4>
                <div style="background: #f0f0f0; height: 10px; border-radius: 5px; margin: 0.5rem 0;">
                    <div style="background: ${productCount >= 45 ? '#ff4757' : productCount >= 35 ? '#ffa500' : '#28a745'}; height: 100%; width: ${(productCount/50)*100}%; border-radius: 5px; transition: all 0.3s ease;"></div>
                </div>
                <p style="margin: 0; color: #666; font-size: 0.9rem;">${remaining} slots remaining</p>
                ${remaining <= 5 ? '<p style="color: #ff4757; font-size: 0.8rem; margin: 0.5rem 0 0 0;">Running low on product slots!</p>' : ''}
            `;
            
            const statsContainer = overview.querySelector('.stats-container') || overview.firstElementChild;
            statsContainer.after(progressDiv);
        });
}

function loadDashboardProducts() {
    if (!currentUser) return;
    
    db.collection('products')
        .where('sellerId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            const productsList = document.getElementById('dashboardProductsList');
            productsList.innerHTML = '';
            
            if (snapshot.empty) {
                productsList.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No products added yet. Add your first product!</p>';
                return;
            }
            
            snapshot.forEach((doc) => {
                const product = { id: doc.id, ...doc.data() };
                const productElement = createDashboardProductCard(product);
                productsList.appendChild(productElement);
            });
        });
}

function createDashboardProductCard(product) {
    const card = document.createElement('div');
    card.className = 'dashboard-product-card';
    
    let deliveryInfo = [];
    if (product.knutsfordDelivery) deliveryInfo.push(`Knutsford: ${product.knutsfordDelivery} days`);
    if (product.taraDelivery) deliveryInfo.push(`Tara: ${product.taraDelivery} days`);
    const deliveryDisplay = deliveryInfo.length > 0 ? deliveryInfo.join(' | ') : 'Not set';
    
    card.innerHTML = `
        <img src="${product.image}" alt="${product.name}" class="product-image-dash">
        <div class="product-info-dash">
            <h4 class="product-title-dash">${product.name}</h4>
            <p style="color: #666; margin: 0.5rem 0; font-size: 0.9rem; line-height: 1.4;">${product.description}</p>
            <div class="product-meta">
                <span><strong>$${product.price}</strong></span>
                <span>Category: ${product.category}</span>
                <span>Delivery: ${deliveryDisplay}</span>
            </div>
        </div>
        <div class="product-actions">
            <button class="btn-edit" onclick="editDashboardProduct('${product.id}')">Edit</button>
            <button class="btn-delete" onclick="deleteDashboardProduct('${product.id}')">Delete</button>
        </div>
    `;
    
    return card;
}

async function handleDashboardAddProduct(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('You must be signed in to add products');
        return;
    }
    
    // Check product limit first
    const limitCheck = await checkProductLimit(currentUser.uid);
    
    if (!limitCheck.canAddMore) {
        alert(`Product limit reached! You can have a maximum of 50 products. You currently have ${limitCheck.currentCount} products.`);
        return;
    }
    
    // Show remaining products info
    if (limitCheck.remaining <= 5) {
        const proceed = confirm(`You have ${limitCheck.remaining} product slots remaining. Continue adding this product?`);
        if (!proceed) return;
    }
    
    // Rest of your existing product addition code...
    // (Keep all your existing validation and product creation code)
    
    const productData = {
        name: document.getElementById('dashboardProductName').value,
        description: document.getElementById('dashboardProductDescription').value,
        price: parseFloat(document.getElementById('dashboardProductPrice').value),
        category: document.getElementById('dashboardProductCategory').value,
        // ... rest of your existing product data
        sellerId: currentUser.uid,
        createdAt: new Date().toISOString()
    };
    
    // Add the product as before
    db.collection('sellers').doc(currentUser.uid).get()
        .then((doc) => {
            if (doc.exists) {
                productData.sellerBusinessName = doc.data().businessName;
                return db.collection('products').add(productData);
            } else {
                throw new Error('Seller profile not found');
            }
        })
        .then((docRef) => {
            alert(`Product added successfully! You have ${limitCheck.remaining - 1} slots remaining.`);
            document.getElementById('dashboardAddProductForm').reset();
            showDashboardTab('my-products');
        })
        .catch((error) => {
            console.error('Error adding product:', error);
            alert('Error adding product: ' + error.message);
        });
}

function editDashboardProduct(productId) {
    // Get product data
    db.collection('products').doc(productId).get()
        .then((doc) => {
            if (doc.exists) {
                const product = doc.data();
                
                // Populate edit form
                document.getElementById('editProductId').value = productId;
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductPrice').value = product.price;
                document.getElementById('editProductDescription').value = product.description;
                document.getElementById('editProductCategory').value = product.category;
                
                // Populate all image fields
                const images = product.images || [product.image];
                for (let i = 1; i <= 5; i++) {
                    const imageField = document.getElementById(`editProductImage${i}`);
                    if (imageField) {
                        imageField.value = images[i-1] || '';
                    }
                }
                
                document.getElementById('editKnutsfordDelivery').value = product.knutsfordDelivery || '';
                document.getElementById('editTaraDelivery').value = product.taraDelivery || '';
                
                // Only populate stock fields if they exist in the form
                const stockField = document.getElementById('editProductStock');
                const alertField = document.getElementById('editLowStockAlert');
                if (stockField) {
                    stockField.value = product.stock || 0;
                }
                if (alertField) {
                    alertField.value = product.lowStockAlert || 5;
                }
                
                // Show modal
                document.getElementById('editProductModal').style.display = 'block';
            }
        })
        .catch((error) => {
            console.error('Error loading product:', error);
            alert('Error loading product details');
        });
}

function closeEditProduct() {
    document.getElementById('editProductModal').style.display = 'none';
}

function handleEditProduct(event) {
    event.preventDefault();
    
    const productId = document.getElementById('editProductId').value;
    
    // Collect all image URLs
    const images = [];
    for (let i = 1; i <= 5; i++) {
        const imageUrl = document.getElementById(`editProductImage${i}`)?.value;
        if (imageUrl && imageUrl.trim()) {
            images.push(imageUrl.trim());
        }
    }
    
    if (images.length === 0) {
        alert('Please provide at least one product image');
        return;
    }
    
    const updatedProduct = {
        name: document.getElementById('editProductName').value,
        description: document.getElementById('editProductDescription').value,
        price: parseFloat(document.getElementById('editProductPrice').value),
        category: document.getElementById('editProductCategory').value,
        image: images[0], // First image as main
        images: images, // All images
        knutsfordDelivery: document.getElementById('editKnutsfordDelivery').value,
        taraDelivery: document.getElementById('editTaraDelivery').value,
        stock: parseInt(document.getElementById('editProductStock').value) || 0,
        lowStockAlert: parseInt(document.getElementById('editLowStockAlert').value) || 5,
        updatedAt: new Date().toISOString()
    };
    
    // Update product in Firestore
    db.collection('products').doc(productId).update(updatedProduct)
        .then(() => {
            alert('Product updated successfully!');
            closeEditProduct();
        })
        .catch((error) => {
            console.error('Error updating product:', error);
            alert('Error updating product: ' + error.message);
        });
}

function deleteDashboardProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
        db.collection('products').doc(productId).delete()
            .then(() => {
                alert('Product deleted successfully!');
            })
            .catch((error) => {
                console.error('Error deleting product:', error);
                alert('Error deleting product: ' + error.message);
            });
    }
}

// ================================
// SELLER ORDERS FUNCTIONS
// ================================
function loadSellerOrders() {
    if (!currentUser) return;
    
    const ordersList = document.getElementById('sellerOrdersList');
    if (!ordersList) return; // Prevent error if element doesn't exist
    
    ordersList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading orders...</div>';
    
    // Clear any existing listener to prevent duplicates
    if (window.sellerOrdersListener) {
        window.sellerOrdersListener();
    }
    
    window.sellerOrdersListener = db.collection('sellerOrders')
        .where('sellerId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            if (!ordersList) return; // Double check element exists
            
            ordersList.innerHTML = '';
            
            if (snapshot.empty) {
                ordersList.innerHTML = '<div style="text-align: center; color: #666; padding: 3rem;">No orders yet. Your products will appear here when customers place orders.</div>';
                return;
            }
            
            snapshot.forEach((doc) => {
                const order = doc.data();
                const orderElement = createSellerOrderCard(order);
                ordersList.appendChild(orderElement);
            });
        }, (error) => {
            console.error('Error loading seller orders:', error);
            if (ordersList) {
                ordersList.innerHTML = `
                    <div style="text-align: center; color: #ff4757; padding: 2rem;">
                        <h3>Error Loading Orders</h3>
                        <p style="margin: 1rem 0; font-family: monospace; background: #f8f8f8; padding: 0.5rem; border-radius: 4px; color: #333;">
                            ${error.code || 'unknown-error'}: ${error.message}
                        </p>
                        <p style="font-size: 0.9rem; color: #666;">
                            This might be due to missing Firestore rules or indexes.
                        </p>
                        <button onclick="loadSellerOrders()" style="background: #007185; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-top: 1rem;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        });
             }
    
function createSellerOrderCard(order) {
    const card = document.createElement('div');
    card.style.cssText = 'background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e9ecef;';
    
    const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
    });
    
    const statusColor = getStatusColor(order.status);
    const statusText = getStatusText(order.status);
    
    card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: #333; margin: 0;">Order #${order.orderNumber}</h3>
            <span style="color: #666; font-size: 0.9rem;">${orderDate}</span>
        </div>
        
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="color: #333; margin-bottom: 1rem;">Customer Information</h4>
            <p style="color: #666; margin: 0;"><strong>Email:</strong> ${order.buyerEmail}</p>
            <p style="color: #666; margin: 0.5rem 0 0 0;"><strong>Delivery:</strong> ${order.shippingAddress?.deliveryLocation || 'Not specified'}</p>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #333; margin-bottom: 1rem;">Items Ordered</h4>
            ${order.items.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid #e9ecef;">
                    <div>
                        <strong>${item.productName}</strong>
                        <span style="color: #666; margin-left: 10px;">Qty: ${item.quantity}</span>
                    </div>
                    <span>${item.subtotal.toFixed(2)}</span>
                </div>
            `).join('')}
            
            <div style="text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #007185;">
                <h4 style="color: #007185; margin: 0;">Total: ${order.subtotal.toFixed(2)}</h4>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="font-weight: 600;">Status:</span>
                <select onchange="updateOrderStatus('${order.orderNumber}', this.value)" style="padding: 0.5rem; border: 2px solid ${statusColor}; border-radius: 6px; background: white; color: #333;">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                </select>
            </div>
            
            <span style="background: ${statusColor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600;">${statusText}</span>
        </div>
    `;
    
    return card;
}

function updateOrderStatus(orderNumber, newStatus) {
    // Update in sellerOrders collection
    db.collection('sellerOrders')
        .where('orderNumber', '==', orderNumber)
        .get()
        .then((snapshot) => {
            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                const orderData = doc.data();
                
                // Update seller order
                doc.ref.update({
                    status: newStatus,
                    updatedAt: new Date().toISOString(),
                    statusHistory: firebase.firestore.FieldValue.arrayUnion({
                        status: newStatus,
                        timestamp: new Date().toISOString(),
                        updatedBy: currentUser.uid
                    })
                });
                
                // Update main order
                const mainOrderRef = db.collection('orders').doc(orderData.mainOrderId);
                mainOrderRef.get().then((orderDoc) => {
                    if (orderDoc.exists) {
                        const order = orderDoc.data();
                        const updatedSellers = { ...order.sellers };
                        
                        // Find and update the seller's status
                        Object.keys(updatedSellers).forEach(sellerId => {
                            if (updatedSellers[sellerId].orderNumber === orderNumber) {
                                updatedSellers[sellerId].status = newStatus;
                            }
                        });
                        
                        mainOrderRef.update({
                            sellers: updatedSellers,
                            updatedAt: new Date().toISOString()
                        });
                        
                        // Trigger email notification via Firebase function
                        triggerStatusUpdateEmail(orderData, newStatus);
                    }
                });
            }
        })
        .catch((error) => {
            console.error('Error updating order status:', error);
            alert('Error updating order status. Please try again.');
        });
}

function triggerStatusUpdateEmail(orderData, newStatus) {
    // Add document to trigger email function
    db.collection('emailTriggers').add({
        type: 'status_update',
        orderNumber: orderData.orderNumber,
        buyerEmail: orderData.buyerEmail,
        sellerName: orderData.sellerName,
        newStatus: newStatus,
        timestamp: new Date().toISOString()
    });
}

function getStatusColor(status) {
    const colors = {
        'pending': '#ffc107',
        'processing': '#007185', 
        'shipped': '#6610f2',
        'delivered': '#28a745'
    };
    return colors[status] || '#6c757d';
}

function getStatusText(status) {
    const texts = {
        'pending': 'Pending',
        'processing': 'Processing',
        'shipped': 'Shipped', 
        'delivered': 'Delivered'
    };
    return texts[status] || 'Unknown';
}


// Add these missing functions:

function showCustomerOrders() {
    if (!currentUser) {
        alert('Please sign in to view your orders');
        return;
    }
    
    document.getElementById('customerOrdersPage').style.display = 'block';
    document.body.style.overflow = 'hidden';
    loadCustomerOrders();
}

function closeCustomerOrders() {
    document.getElementById('customerOrdersPage').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function loadCustomerOrders() {
    if (!currentUser) return;
    
    const ordersList = document.getElementById('customerOrdersList');
    ordersList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading your orders...</div>';
    
    db.collection('orders')
        .where('buyerId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            ordersList.innerHTML = '';
            
            if (snapshot.empty) {
                ordersList.innerHTML = '<div style="text-align: center; color: #666; padding: 3rem;">No orders yet. Start shopping to see your orders here!</div>';
                return;
            }
            
            snapshot.forEach((doc) => {
                const order = { id: doc.id, ...doc.data() };
                const orderElement = createCustomerOrderCard(order);
                ordersList.appendChild(orderElement);
            });
        });
}

function createCustomerOrderCard(order) {
    const card = document.createElement('div');
    card.style.cssText = 'background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e9ecef;';
    
    const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
    });
    
    let sellersHTML = '';
    Object.entries(order.sellers || {}).forEach(([sellerId, sellerData]) => {
        const statusColor = getStatusColor(sellerData.status);
        const statusText = getStatusText(sellerData.status);
        
        sellersHTML += `
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="color: #333; margin: 0;">From: ${sellerData.sellerName}</h4>
                    <span style="background: ${statusColor}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">${statusText}</span>
                </div>
                
                ${sellerData.items.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                        <div>
                            <strong>${item.productName}</strong>
                            <span style="color: #666; margin-left: 10px;">x${item.quantity}</span>
                        </div>
                        <span>$${item.subtotal.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        `;
    });
    
    card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: #333; margin: 0;">Order #${order.orderId}</h3>
            <span style="color: #666; font-size: 0.9rem;">${orderDate}</span>
        </div>
        
        ${sellersHTML}
        
        <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
            <h4 style="color: #007185; margin: 0;">Total: $${order.totalAmount.toFixed(2)}</h4>
        </div>
    `;
    
    return card;
    }


function formatPrice(price) {
    const num = parseFloat(price) || 0;
    const dollars = Math.floor(num);
    const cents = Math.round((num - dollars) * 100);
    
    // Format dollars with commas
    const formattedDollars = new Intl.NumberFormat('en-US').format(dollars);
    
    // Return with superscript cents
    return `${formattedDollars}<sup style="font-size: 0.6em; vertical-align: top;">${cents.toString().padStart(2, '0')}</sup>`;
}

function formatJMDPrice(price) {
    const num = parseFloat(price) || 0;
    const dollars = Math.floor(num);
    const cents = Math.round((num - dollars) * 100);
    
    // Format dollars with commas
    const formattedDollars = new Intl.NumberFormat('en-US').format(dollars);
    
    // Return with superscript cents
    return `${formattedDollars}<sup style="font-size: 0.6em; vertical-align: top;">${cents.toString().padStart(2, '0')}</sup>`;
}
// ================================
// PAYPAL SETUP FUNCTIONS
// ================================
function showPayPalSetupNotification() {
    // Check if notification already exists
    const existingNotification = document.querySelector('.paypal-setup-notification');
    if (existingNotification) {
        return; // Don't create duplicate
    }
    
    const notification = document.createElement('div');
    notification.className = 'paypal-setup-notification';
    notification.style.cssText = `
        background: #ff9800;
        color: white;
        padding: 1rem;
        text-align: center;
        border-radius: 8px;
        margin: 1rem 0;
        cursor: pointer;
    `;
    notification.innerHTML = `
        <strong>⚠️ PayPal Setup Required</strong><br>
        Complete your PayPal setup to receive payments
    `;
    notification.onclick = () => showPayPalSetup();
    
    const dashboard = document.querySelector('#sellerDashboardPage .dashboard-content-wrapper');
    if (dashboard) {
        dashboard.insertBefore(notification, dashboard.firstChild);
    }
}

function showPayPalSetup() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 1rem;">PayPal Setup</h2>
            
            <form id="paypalSetupForm" onsubmit="handlePayPalSetup(event)">
                <div class="form-group">
                    <label>PayPal Email Address:</label>
                    <input type="email" id="paypalEmail" required placeholder="Enter your PayPal email">
                    <small style="color: #ccc; display: block; margin-top: 0.3rem;">
                        This is where you'll receive payments from sales
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Confirm PayPal Email:</label>
                    <input type="email" id="confirmPaypalEmail" required placeholder="Confirm your PayPal email">
                </div>
                
                <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid rgba(255, 215, 0, 0.3);">
                    <h4 style="color: #ffd700; margin: 0 0 0.5rem 0;">Payment Terms:</h4>
                    <ul style="color: #ccc; margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                        <li>5% platform fee on all sales</li>
                        <li>PayPal processing fees apply</li>
                        <li>Payments processed within 24-48 hours</li>
                        <li>Minimum payout: $20</li>
                    </ul>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Setup PayPal Account</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function handlePayPalSetup(event) {
    event.preventDefault();
    
    const paypalEmail = document.getElementById('paypalEmail').value;
    const confirmEmail = document.getElementById('confirmPaypalEmail').value;
    
    if (paypalEmail !== confirmEmail) {
        alert('PayPal email addresses do not match');
        return;
    }
    
    // Update seller with PayPal information
    db.collection('sellers').doc(currentUser.uid).update({
        paypalEmail: paypalEmail,
        paymentSetupComplete: true,
        paypalSetupDate: new Date().toISOString()
    }).then(() => {
        alert('PayPal setup completed successfully!');
        document.querySelector('.modal').remove();
        location.reload(); // Refresh dashboard
    }).catch((error) => {
        console.error('PayPal setup error:', error);
        alert('Error setting up PayPal. Please try again.');
    });
}


// Add this near the top of your script section
const JMD_TO_USD_RATE = 0.0065; // Approximate rate - you should get real-time rates

function convertJMDToUSD(jmdAmount) {
    return (jmdAmount * JMD_TO_USD_RATE).toFixed(2);
}

function convertUSDToJMD(usdAmount) {
    return (usdAmount / JMD_TO_USD_RATE).toFixed(2);
}

// Get real-time exchange rate (optional enhancement)
async function getCurrentExchangeRate() {
    try {
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/JMD');
        const data = await response.json();
        return data.rates.USD;
    } catch (error) {
        console.error('Could not fetch exchange rate, using default');
        return JMD_TO_USD_RATE;
    }
}

function updateFinancialOverview(sellerData) {
    // This function would be called to update financial overview
    // Implementation depends on your specific financial tracking needs
    console.log('Updating financial overview for seller:', sellerData.businessName);
}

function initializePhotoGallery(productId) {
    currentProductId = productId;
    currentPhotoIndex = 0;
    
    const container = document.getElementById(`photoContainer-${productId}`);
    if (!container) {
        return;
    }
    
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let isScrolling = null;
    
    container.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
        isScrolling = null;
    }, { passive: true });
    
    container.addEventListener('touchmove', (e) => {
        if (!touchStartX || !touchStartY) return;
        
        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = touchStartX - touchX;
        const deltaY = touchStartY - touchY;
        
        // Determine scroll direction on first move
        if (isScrolling === null) {
            isScrolling = Math.abs(deltaX) < Math.abs(deltaY) ? 'vertical' : 'horizontal';
        }
        
        // Only prevent default for clear horizontal swipes
        if (isScrolling === 'horizontal' && Math.abs(deltaX) > 20) {
            e.preventDefault();
        }
    }, { passive: false });
    
    container.addEventListener('touchend', (e) => {
        if (!e.changedTouches[0]) return;
        
        const touchEndX = e.changedTouches[0].clientX;
        const deltaX = touchEndX - touchStartX;
        const deltaTime = Date.now() - touchStartTime;
        
        // Only trigger photo change for clear horizontal swipes
        if (isScrolling === 'horizontal' && Math.abs(deltaX) > 50 && deltaTime < 500) {
            if (deltaX > 50) {
                changePhoto(currentProductId, -1);
            } else if (deltaX < -50) {
                changePhoto(currentProductId, 1);
            }
        }
        
        // Reset values
        touchStartX = 0;
        touchStartY = 0;
        isScrolling = null;
    }, { passive: true });
    
    // Mouse events for desktop
    container.addEventListener('mousedown', handlePointerStart);
    container.addEventListener('mousemove', handlePointerMove);
    container.addEventListener('mouseup', handlePointerEnd);
    container.addEventListener('mouseleave', handlePointerEnd);
    
    container.addEventListener('dragstart', e => e.preventDefault());
}

function handlePointerStart(e) {
    isPointerDown = true;
    startTime = Date.now();
    const container = e.currentTarget;
    
    if (e.type === 'mousedown') {
        startX = e.clientX;
        container.style.cursor = 'grabbing';
    } else if (e.type === 'touchstart') {
        startX = e.touches[0].clientX;
    }
    
    currentX = startX;
    container.classList.add('dragging');
}

function handlePointerMove(e) {
    if (!isPointerDown) return;
    
    const container = e.currentTarget;
    
    if (e.type === 'mousemove') {
        currentX = e.clientX;
    } else if (e.type === 'touchmove') {
        currentX = e.touches[0].clientX;
        
        // Only prevent default for horizontal swipes, allow vertical scrolling
        const deltaX = Math.abs(currentX - startX);
        const deltaY = Math.abs(e.touches[0].clientY - (e.touches[0].clientY || 0));
        
        // If horizontal movement is greater than vertical, prevent default (horizontal swipe)
        if (deltaX > deltaY) {
            e.preventDefault();
        }
    }
    
    const deltaX = currentX - startX;
    const baseTransform = -currentPhotoIndex * 20;
    const dragPercent = (deltaX / container.offsetWidth) * 20;
    
    container.style.transform = `translateX(${baseTransform + dragPercent}%)`;
}

function handlePointerEnd(e) {
    if (!isPointerDown) return;
    
    isPointerDown = false;
    const container = e.currentTarget;
    const deltaX = currentX - startX;
    const deltaTime = Date.now() - startTime;
    const velocity = Math.abs(deltaX) / deltaTime;
    
    container.style.cursor = 'grab';
    container.classList.remove('dragging');
    
    // Determine if swipe was significant enough
    const threshold = 50; // Minimum pixels to trigger swipe
    const shouldSwipe = Math.abs(deltaX) > threshold || velocity > 0.3;
    
    if (shouldSwipe) {
        if (deltaX > 0) {
            changePhoto(currentProductId, -1);
        } else {
            changePhoto(currentProductId, 1);
        }
    } else {
        updatePhotoDisplay(currentProductId);
    }
}

function changePhoto(productId, direction) {
    const product = products.find(p => p.id === productId);
    const images = (product.images || [product.image]).filter(img => img);
    
    currentPhotoIndex += direction;
    if (currentPhotoIndex >= images.length) currentPhotoIndex = 0;
    if (currentPhotoIndex < 0) currentPhotoIndex = images.length - 1;
    
    updatePhotoDisplay(productId);
}

function goToPhoto(productId, index) {
    currentPhotoIndex = index;
    updatePhotoDisplay(productId);
}

function updatePhotoDisplay(productId) {
    const container = document.getElementById(`photoContainer-${productId}`);
    const dots = document.querySelectorAll('.photo-dot');
    
    if (container) {
        const newTransform = `translateX(-${currentPhotoIndex * 20}%)`;
        container.style.transform = newTransform;
        
        // Re-enable transition
        container.style.transition = 'transform 0.3s ease';
        setTimeout(() => {
            container.style.transition = '';
        }, 300);
    }
    
    dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentPhotoIndex);
    });
}

// ================================
// UTILITY FUNCTIONS
// ================================
function calculateDeliveryDates(deliveryDays) {
    try {
        if (!deliveryDays || typeof deliveryDays !== 'string') {
            return null;
        }
        
        const parts = deliveryDays.split('-');
        if (parts.length !== 2) {
            return null;
        }
        
        const minDays = parseInt(parts[0]);
        const maxDays = parseInt(parts[1]);
        
        if (isNaN(minDays) || isNaN(maxDays)) {
            return null;
        }
        
        const today = new Date();
        
        const startDate = new Date(today);
        startDate.setDate(today.getDate() + minDays);
        
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + maxDays);
        
        return {
            start: startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
            end: endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        };
    } catch (error) {
        console.error('Error calculating delivery dates:', error);
        return null;
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function sendStatusUpdateEmail(customerEmail, orderNumber, status, sellerName) {
    console.log(`Email notification: Order ${orderNumber} from ${sellerName} is now ${status} for ${customerEmail}`);
    // Here you would integrate with your email service
}

function emailOrderDetails(orderId) {
    console.log(`Emailing order details for ${orderId}`);
    alert('Order details have been sent to your email address.');
    // Here you would integrate with your email service
}

// ================================
// CUSTOMER ORDERS FUNCTIONS
// ================================
function showCustomerOrders() {
    if (!currentUser) {
        alert('Please sign in to view your orders');
        return;
    }
    
    document.getElementById('customerOrdersPage').style.display = 'block';
    document.body.style.overflow = 'hidden';
    loadCustomerOrders();
}

function closeCustomerOrders() {
    document.getElementById('customerOrdersPage').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function loadCustomerOrders() {
    if (!currentUser) return;
    
    const ordersList = document.getElementById('customerOrdersList');
    ordersList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading your orders...</div>';
    
    db.collection('orders')
        .where('buyerId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            ordersList.innerHTML = '';
            
            if (snapshot.empty) {
                ordersList.innerHTML = '<div style="text-align: center; color: #666; padding: 3rem;">No orders yet. Start shopping to see your orders here!</div>';
                return;
            }
            
            snapshot.forEach((doc) => {
                const order = { id: doc.id, ...doc.data() };
                const orderElement = createCustomerOrderCard(order);
                ordersList.appendChild(orderElement);
            });
        }, (error) => {
            console.error('Error loading customer orders:', error);
            ordersList.innerHTML = '<div style="text-align: center; color: #ff4757; padding: 2rem;">Error loading orders. Please try again.</div>';
        });
}


    async function checkProductLimit(sellerId) {
    try {
        const snapshot = await db.collection('products')
            .where('sellerId', '==', sellerId)
            .get();
        
        return {
            currentCount: snapshot.size,
            canAddMore: snapshot.size < 50,
            remaining: Math.max(0, 50 - snapshot.size)
        };
    } catch (error) {
        console.error('Error checking product limit:', error);
        return { currentCount: 0, canAddMore: true, remaining: 50 };
    }
    }
    
function createCustomerOrderCard(order) {
    const card = document.createElement('div');
    card.style.cssText = 'background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e9ecef;';
    
    const orderDate = new Date(order.createdAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long', 
        day: 'numeric'
    });
    
    let sellersHTML = '';
    Object.entries(order.sellers).forEach(([sellerId, sellerData]) => {
        const statusColor = getStatusColor(sellerData.status);
        const statusText = getStatusText(sellerData.status);
        
        sellersHTML += `
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="color: #333; margin: 0;">From: ${sellerData.sellerName}</h4>
                    <span style="background: ${statusColor}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">${statusText}</span>
                </div>
                
                ${sellerData.items.map(item => `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                        <div>
                            <strong>${item.productName}</strong>
                            <span style="color: #666; margin-left: 10px;">x${item.quantity}</span>
                        </div>
                        <span>${item.subtotal.toFixed(2)}</span>
                    </div>
                `).join('')}
                
                <div style="text-align: right; margin-top: 0.5rem;">
                    <strong style="color: #007185;">Subtotal: ${sellerData.subtotal.toFixed(2)}</strong>
                </div>
            </div>
        `;
    });
    
    card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: #333; margin: 0;">Order #${order.orderId}</h3>
            <span style="color: #666; font-size: 0.9rem;">${orderDate}</span>
        </div>
        
        ${sellersHTML}
        
        <div style="background: rgba(255, 215, 0, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
            <h4 style="color: #007185; margin: 0;">Total: ${order.totalAmount.toFixed(2)}</h4>
            <p style="color: #666; font-size: 0.8rem; margin: 0.5rem 0 0 0;">
                Delivery: ${order.shippingAddress?.deliveryLocation || 'Not specified'}
            </p>
        </div>
        
        <div style="text-align: center; margin-top: 1rem;">
            <button onclick="emailOrderDetails('${order.orderId}')" style="background: #007185; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Email Order Details</button>
        </div>
    `;
    
    return card;
}
  </script>
</body>
</html>
